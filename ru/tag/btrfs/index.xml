<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Btrfs | Д. С. Кулябов</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link><atom:link href="https://yamadharma.github.io/ru/tag/btrfs/index.xml" rel="self" type="application/rss+xml"/><description>Btrfs</description><generator>Hugo Blox Builder (https://hugoblox.com)</generator><language>ru-ru</language><copyright>© 2025 Dmitry S. Kulyabov</copyright><lastBuildDate>Fri, 23 Feb 2024 18:08:00 +0300</lastBuildDate><image><url>https://yamadharma.github.io/media/icon_hu_3756dbc1adf0ae14.png</url><title>Btrfs</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link></image><item><title>Дедупликация файлов. jdupes</title><link>https://yamadharma.github.io/ru/post/2024/02/23/file-deduplication-jdupes/</link><pubDate>Fri, 23 Feb 2024 18:08:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2024/02/23/file-deduplication-jdupes/</guid><description>&lt;p&gt;Дедупликация файлов. jdupes.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#примеры"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Примеры&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Сайт:
&lt;/li&gt;
&lt;li&gt;Репозиторий:
&lt;ul&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;&lt;del&gt;
&lt;/del&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Форк &lt;code&gt;fdupes&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Включает поддержку дедупликации BTRFS.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="примеры"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Примеры&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Команда применяется к списку каталогов.&lt;/li&gt;
&lt;li&gt;Найти дубликаты файлов:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;jdupes --recurse --print-summarize dir1 dir2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Преобразовать дубликаты в жёсткие ссылки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;jdupes --recurse --link-hard dir1 dir2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>btrfs. Контрольные суммы</title><link>https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/</link><pubDate>Mon, 19 Feb 2024 15:44:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/</guid><description>&lt;p&gt;Контрольные суммы btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#виды-контрольных-сумм"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Виды контрольных сумм&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Контрольная сумма вычисляется для данных и метаданных (по умолчанию).&lt;/li&gt;
&lt;li&gt;Контрольная сумма вычисляется перед записью и проверяется после чтения блоков с устройств.&lt;/li&gt;
&lt;li&gt;Контрольная сумма всего блока метаданных хранится в заголовке узла b-дерева.&lt;/li&gt;
&lt;li&gt;У каждого блока данных есть отдельная контрольная сумма, хранящаяся в дереве контрольных сумм.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="виды-контрольных-сумм"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Виды контрольных сумм&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;CRC32C&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;32-битный дайджест;&lt;/li&gt;
&lt;li&gt;используется по умолчанию;&lt;/li&gt;
&lt;li&gt;лучшая обратная совместимость;&lt;/li&gt;
&lt;li&gt;очень быстро вычисляется;&lt;/li&gt;
&lt;li&gt;современные процессоры имеют поддержку на уровне инструкций;&lt;/li&gt;
&lt;li&gt;не устойчивы к коллизиям;&lt;/li&gt;
&lt;li&gt;достаточно хорошие возможности обнаружения ошибок.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;XXHASH&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;64-битный дайджест;&lt;/li&gt;
&lt;li&gt;может использоваться в качестве преемника CRC32C;&lt;/li&gt;
&lt;li&gt;очень быстро вычисляется;&lt;/li&gt;
&lt;li&gt;оптимизирована для современных процессоров, использующих конвейерную обработку инструкций;&lt;/li&gt;
&lt;li&gt;хорошая устойчивость к коллизиям;&lt;/li&gt;
&lt;li&gt;хорошее обнаружение ошибок.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SHA256&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;256-битный дайджест;&lt;/li&gt;
&lt;li&gt;хэш криптографической стойкости;&lt;/li&gt;
&lt;li&gt;относительно медленный, но с возможным ускорением инструкций ЦП или специализированными аппаратными картами;&lt;/li&gt;
&lt;li&gt;сертифицированный FIPS;&lt;/li&gt;
&lt;li&gt;широко используется.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;BLAKE2b&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;256-битный дайджест;&lt;/li&gt;
&lt;li&gt;хеш криптографической стойкости;&lt;/li&gt;
&lt;li&gt;быстрее SHA256;&lt;/li&gt;
&lt;li&gt;возможно ускорение с использованием расширений SIMD;&lt;/li&gt;
&lt;li&gt;не стандартизировано;&lt;/li&gt;
&lt;li&gt;широко используется;&lt;/li&gt;
&lt;li&gt;алгоритм BLAKE2b-256 оптимизирован для 64-битных платформ.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Восстановление btrfs</title><link>https://yamadharma.github.io/ru/post/2023/07/21/btrfs-recovery/</link><pubDate>Fri, 21 Jul 2023 16:56:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2023/07/21/btrfs-recovery/</guid><description>&lt;p&gt;Восстановление btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#предварительная-подготовка"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Предварительная подготовка&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#восстановление"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Восстановление&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="предварительная-подготовка"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Предварительная подготовка&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Подготовьте флеш-диск (см.
)&lt;/li&gt;
&lt;li&gt;Поместите на него образ SystemRescueCD (
).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="восстановление"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Восстановление&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Загружаемся с внешнего устройства.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;При загрузке с SystemRescueCD лучше выбрать пункт &lt;code&gt;copy system to RAM&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Запускаем проверку блоков:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sda1 /mnt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs scrub start -Bd /mnt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Если система на монтируется, проверяем блоки на устройстве:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs scrub start -Bd /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Если не монтируется, попробуйте смонтировать для чтения:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o rescue /dev/sda1 /mnt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Запустите проверку файловой системы:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs check /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Если не поможет, скопируйте файловую систему:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs restore /dev/sda1 /mnt/usbdrive
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Попробуйте восстановить суперблок:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs rescue super-recover /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Попробуйте удалить лог:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs rescue zero-log /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Попробуйте восстановить чанки:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs rescue chunk-recover /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Запускаем восстановление файловой системы на устройстве (это может быть опасно):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs check --repair /dev/sda1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Запускаем проверку блоков:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sda1 /mnt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs scrub start -Bd /mnt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Дедупликация btrfs. Bees</title><link>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</link><pubDate>Sat, 28 May 2022 14:51:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</guid><description>&lt;p&gt;BEES (Best-Effort Extent-Same) &amp;mdash; агент дедупликации &lt;em&gt;btrfs&lt;/em&gt;.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#плюсы-и-минусы"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Плюсы и минусы&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#сильные-стороны"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; Сильные стороны&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#слабые-стороны"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; Слабые стороны&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#установка"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Установка&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#использование"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Использование&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#запуск"&gt;&lt;span class="section-num"&gt;4.1&lt;/span&gt; Запуск&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#конфигурация"&gt;&lt;span class="section-num"&gt;4.2&lt;/span&gt; Конфигурация&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Репозиторий:
&lt;/li&gt;
&lt;li&gt;Сайт:
&lt;/li&gt;
&lt;li&gt;Уровень дедупликации: блочный.&lt;/li&gt;
&lt;li&gt;Работает как демон.&lt;/li&gt;
&lt;li&gt;Поддерживается инкрементное сканирование данных.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="плюсы-и-минусы"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Плюсы и минусы&lt;/h2&gt;
&lt;h3 id="сильные-стороны"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; Сильные стороны&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Хеш-таблица с эффективным использованием места, можно использовать всего 1 ГБ хеш-таблицы на 10 ТБ уникальных данных.&lt;/li&gt;
&lt;li&gt;Демон постепенно выполняет дедупликацию новых данных, используя поиск по дереву btrfs.&lt;/li&gt;
&lt;li&gt;Поддержка сжатия btrfs, дедупликация комбинации сжатых и несжатых файлов.&lt;/li&gt;
&lt;li&gt;Постоянная хеш-таблица для быстрого перезапуска после выключения.&lt;/li&gt;
&lt;li&gt;Дедупликация всей файловой системы, включая моментальные снимки.&lt;/li&gt;
&lt;li&gt;Постоянный размер хеш-таблицы: использование оперативной памяти не увеличивается, если набор данных становится больше.&lt;/li&gt;
&lt;li&gt;Автоматическое саморегулирование в зависимости от загрузки системы.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="слабые-стороны"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; Слабые стороны&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Дедупликация только всей файловой системы.&lt;/li&gt;
&lt;li&gt;Требуются привилегии &lt;code&gt;root&lt;/code&gt; (или &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Первый запуск может увеличить использование пространства метаданных, если существует много моментальных снимков.&lt;/li&gt;
&lt;li&gt;Постоянный размер хеш-таблицы: использование оперативной памяти не уменьшается, если набор данных становится меньше.&lt;/li&gt;
&lt;li&gt;Работает только с &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="установка"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Установка&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Gentoo:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;emerge bees
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="использование"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Использование&lt;/h2&gt;
&lt;h3 id="запуск"&gt;&lt;span class="section-num"&gt;4.1&lt;/span&gt; Запуск&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Для запуска используем скрипт &lt;code&gt;beesd&lt;/code&gt; (в исходниках &lt;code&gt;scripts/beesd&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Посмотрим идентификаторы &lt;code&gt;UUID&lt;/code&gt; файловых систем:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs filesystem show
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Активируем демон дедупликации, указав &lt;code&gt;UUID&lt;/code&gt; в качестве идентификатора инстанса. Пусть &lt;code&gt;UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code&gt;, тогда команда активации будет иметь вид:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;systemctl &lt;span class="nb"&gt;enable&lt;/span&gt; --now beesd@f8963df3-1320-4bc0-a125-62be185b029e
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="конфигурация"&gt;&lt;span class="section-num"&gt;4.2&lt;/span&gt; Конфигурация&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Для работы демона необходим файл конфигурации.&lt;/li&gt;
&lt;li&gt;Шаблон для файла конфигурации:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/etc/bees/beesd.conf.sample
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Скопируйте его, задав произвольное имя (например, &lt;code&gt;root.conf&lt;/code&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;cp /etc/bees/beesd.conf.sample /etc/bees/root.conf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;В этом файле задайте поле &lt;code&gt;UUID&lt;/code&gt; с необходимым значение.&lt;/li&gt;
&lt;li&gt;Для запуска необходимо наличие файла с расширением &lt;code&gt;.conf&lt;/code&gt; и поля &lt;code&gt;UUID&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Остальные поля конфигурации настраиваются по желанию. В противном случае используются значения по умолчанию.&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Дедупликация файловой системы btrfs</title><link>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</link><pubDate>Thu, 26 May 2022 14:29:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</guid><description>&lt;p&gt;Дедупликация файловой системы btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#реализация"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Реализация&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#duperemove"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; duperemove&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#bees"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; bees&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#bedup"&gt;&lt;span class="section-num"&gt;2.3&lt;/span&gt; bedup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#btrfs-dedup"&gt;&lt;span class="section-num"&gt;2.4&lt;/span&gt; btrfs-dedup&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#дедупликация-на-уровне-файлов"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Дедупликация на уровне файлов&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При дедупликации идентифицируются блоки данных, которые имеют общие последовательности.&lt;/li&gt;
&lt;li&gt;Они объединяются в один экстент с семантикой копирования при записи.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="реализация"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Реализация&lt;/h2&gt;
&lt;h3 id="duperemove"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; duperemove&lt;/h3&gt;
&lt;h3 id="bees"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; bees&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;Уровень дедупликации: блочный.&lt;/li&gt;
&lt;li&gt;Работает как демон.&lt;/li&gt;
&lt;li&gt;Использую для дедупликации файловой системы.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="bedup"&gt;&lt;span class="section-num"&gt;2.3&lt;/span&gt; bedup&lt;/h3&gt;
&lt;h3 id="btrfs-dedup"&gt;&lt;span class="section-num"&gt;2.4&lt;/span&gt; btrfs-dedup&lt;/h3&gt;
&lt;h2 id="дедупликация-на-уровне-файлов"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Дедупликация на уровне файлов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Некоторые утилиты для дедупликации на уровне файлов поддерживают файловую систему &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Файл подкачки на btrfs</title><link>https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/</link><pubDate>Fri, 20 May 2022 10:29:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/</guid><description>&lt;p&gt;Размещение файла подкачки на разделе &lt;em&gt;btrfs&lt;/em&gt;.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#создание-файла-подкачки"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Создание файла подкачки&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;btrfs поддерживает файл подкачки (начиная с ядра версии 5.0).&lt;/li&gt;
&lt;li&gt;Файл подкачки &lt;strong&gt;не может&lt;/strong&gt; находиться на любом рейде btrfs.&lt;/li&gt;
&lt;li&gt;btrfs не позволяет создавать снапшоты, если на подтоме есть рабочий файл подкачки.&lt;/li&gt;
&lt;li&gt;Рекомендуется размещать файл подкачки на отдельном подтоме.&lt;/li&gt;
&lt;li&gt;Файл подкачки должен иметь свойство NODATACOW.&lt;/li&gt;
&lt;li&gt;Файл подкачки должен быть без сжатия.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="создание-файла-подкачки"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Создание файла подкачки&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Подмонтируем раздел с btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/gentoo
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим подтом для файла подкачки на btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отмонтируем том btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/gentoo
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим точку монтирования:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем подтом &lt;code&gt;@swap&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o &lt;span class="nv"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;@swap /dev/sda4 /swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отключим для этого подтома CoW:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C /swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;truncate -s &lt;span class="m"&gt;0&lt;/span&gt; /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отключим сжатие:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs property &lt;span class="nb"&gt;set&lt;/span&gt; /swap/swapfile compression &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Установим права доступа &lt;code&gt;600&lt;/code&gt; к файлу подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chmod &lt;span class="m"&gt;600&lt;/span&gt; /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Установим размер файла подкачки.
&lt;ul&gt;
&lt;li&gt;Можно задать размер вручную (например, 4GiB):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;fallocate -l 4G /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Можно установить размер файла подкачки исходя из размера оперативной памяти:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;fallocate -l &lt;span class="k"&gt;$(&lt;/span&gt;free -h --si &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt; /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Отформатируем файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkswap /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Активируем файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;swapon /swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Добавим запись в &lt;code&gt;/etc/fstab&lt;/code&gt;, чтобы подключать файл подкачки при загрузке (для устройства с &lt;code&gt;UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;UUID=&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34; /swap btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@swap 0 0
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/swap/swapfile none swap sw 0 0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Проверьте, что файл &lt;code&gt;/etc/fstab&lt;/code&gt; не содержит ошибок:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;findmnt --verify --verbose
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Обслуживание btrfs</title><link>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</link><pubDate>Thu, 23 Sep 2021 10:22:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</guid><description>&lt;p&gt;Действия по обслуживанию Btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#проверка-целостности"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Проверка целостности&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#дефрагментация"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Дефрагментация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#trim"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Trim&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#балансировка"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Балансировка&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#скрипт-btrfsmaintenance"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Скрипт btrfsmaintenance&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;5.1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#установка"&gt;&lt;span class="section-num"&gt;5.2&lt;/span&gt; Установка&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#запуск"&gt;&lt;span class="section-num"&gt;5.3&lt;/span&gt; Запуск&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#удаление"&gt;&lt;span class="section-num"&gt;5.4&lt;/span&gt; Удаление&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#фалы-конфигурации"&gt;&lt;span class="section-num"&gt;5.5&lt;/span&gt; Фалы конфигурации&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="проверка-целостности"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Проверка целостности&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Следующая команда считывает все блоки данных и метаданных со всех устройств и проверяет контрольные суммы:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs scrub start -Bd &amp;lt;путь&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Автоматически восстанавливает поврежденные блоки, если есть правильная копия.&lt;/li&gt;
&lt;li&gt;Не является средством проверки файловой системы (fsck) и не проверяет и не устраняет структурные повреждения в файловой системе.&lt;/li&gt;
&lt;li&gt;Пользователь должен запускать его вручную или через периодическую системную службу. Рекомендуемый период составляет месяц, но может быть и меньше.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="дефрагментация"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Дефрагментация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При первой записи Btrfs записывает данные последовательно.&lt;/li&gt;
&lt;li&gt;Механизм COW (Copy-On-Write) подразумевает, что любая последующая модификация файла не должна быть написана поверх старых данных, и соответственно, она помещается в свободный блок.&lt;/li&gt;
&lt;li&gt;Данное обстоятельство вызывает повышенную фрагментацию файловой системы.&lt;/li&gt;
&lt;li&gt;В Btrfs для борьбы с фрагментацией существует несколько методов:
&lt;ul&gt;
&lt;li&gt;дефрагментация с помощью команды
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs filesystem defragment &amp;lt;путь&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;опция монтирования &lt;code&gt;-o nodatacow&lt;/code&gt;, которая отключает COW для данных.
&lt;ul&gt;
&lt;li&gt;Можно применять к отдельному файлу либо к подтому/директории, в том числе рекурсивно.&lt;/li&gt;
&lt;li&gt;Атрибут &lt;code&gt;nocow&lt;/code&gt; можно также выставить новому или пустому файлу.&lt;/li&gt;
&lt;li&gt;Он отключает механизм &lt;em&gt;copy on write&lt;/em&gt;, благодаря чему Btrfs при обновлении содержимого файла будет всегда работать с фиксированной дисковой областью, записывая данные поверх существующих (на физическом уровне).&lt;/li&gt;
&lt;li&gt;Включение атрибута &lt;code&gt;nocow&lt;/code&gt; отключает проверку контрольной суммы файлов.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;опция монтирования &lt;code&gt;-o autodefrag&lt;/code&gt;.
&lt;ul&gt;
&lt;li&gt;Обнаруживает небольшие случайные записи в файлы и ставит их в очередь для автоматического дефрагментации, поэтому файловая система будет дефрагментировать себя, пока она используется.&lt;/li&gt;
&lt;li&gt;Не подходит для виртуализации или высоконагруженных баз данных, но хорошо работает для небольших файлов.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Оценить фрагментированность файлов можно при помощи утилиты &lt;code&gt;filefrag&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="trim"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Trim&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Btrfs может передавать SSD информацию о том, какие блоки данных больше не используются (удалённые файлы и т.д.).&lt;/li&gt;
&lt;li&gt;Это позволяет избежать постепенного снижения производительности SSD.&lt;/li&gt;
&lt;li&gt;Операция &lt;code&gt;fstrim&lt;/code&gt; предназначена для таких целей. Для большинства современных SSD она доступна.&lt;/li&gt;
&lt;li&gt;Btrfs автоматически определяет при монтировании твердотельные накопители.&lt;/li&gt;
&lt;li&gt;Для работы &lt;code&gt;fstrim&lt;/code&gt; необходим ручной запуск или установка опции монтирования &lt;code&gt;-o discard&lt;/code&gt;, которая будет запускать &lt;code&gt;fstrim&lt;/code&gt; после каждого удаления файла.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="балансировка"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Балансировка&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Основной целью функции &lt;code&gt;balance&lt;/code&gt; является распределение групп блоков по всем устройствам.&lt;/li&gt;
&lt;li&gt;Работает только на смонтированной файловой системе.&lt;/li&gt;
&lt;li&gt;Btrfs использует двуступенчатый распределитель:
&lt;ul&gt;
&lt;li&gt;на первом этапе выделяются большие области пространства, известные как чанки (chunks) для определенных типов данных;&lt;/li&gt;
&lt;li&gt;на втором этапе выделяются блоки (blocks).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Существует три типа чанков:
&lt;ul&gt;
&lt;li&gt;Data chunks хранят обычные данные файла.&lt;/li&gt;
&lt;li&gt;Metadata Chunks хранят метаданные о файлах, включая, метки времени, контрольные суммы, имена файлов, владельца, разрешения и расширенные атрибуты.&lt;/li&gt;
&lt;li&gt;System Chunks это особый тип чанков, которые хранят данные о том, где находятся все остальные чанки.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Только тот тип данных, для которого выделен блок, может быть сохранен в этом блоке.&lt;/li&gt;
&lt;li&gt;Ошибка &lt;code&gt;ENOSPC&lt;/code&gt; в Btrfs. Файловая система исчерпала пространство для данных или метаданных в существующих чанках и не может выделить новый чанк.
&lt;ul&gt;
&lt;li&gt;Запустите &lt;code&gt;btrfs fi df &amp;lt;путь&amp;gt;&lt;/code&gt; в файловой системе, которая вызвала ошибку.&lt;/li&gt;
&lt;li&gt;Если в строке &amp;ldquo;Данные&amp;rdquo; или &amp;ldquo;Метаданные&amp;rdquo; отображается значение &amp;ldquo;Итого&amp;rdquo;, которое значительно отличается от значения &amp;ldquo;Используется&amp;rdquo;, то это, вероятно, является причиной.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Команда &lt;code&gt;btrfs balance&lt;/code&gt; отправляет данные обратно через распределитель (allocator), что приводит к более компактному использованию чанков.&lt;/li&gt;
&lt;li&gt;Если запустить &lt;code&gt;btrfs fi df &amp;lt;путь&amp;gt;&lt;/code&gt; после запуска баланса, значения Total и Used станут намного ближе друг к другу, так как баланс удаляет фрагменты, которые больше не нужны.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="скрипт-btrfsmaintenance"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Скрипт btrfsmaintenance&lt;/h2&gt;
&lt;h3 id="общая-информация"&gt;&lt;span class="section-num"&gt;5.1&lt;/span&gt; Общая информация&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Выполняемые действия:
&lt;ul&gt;
&lt;li&gt;периодическая проверка целостности;&lt;/li&gt;
&lt;li&gt;периодическая балансировка;&lt;/li&gt;
&lt;li&gt;периодический trim для SSD;&lt;/li&gt;
&lt;li&gt;периодическая дефрагментация.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Репозиторий:
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="установка"&gt;&lt;span class="section-num"&gt;5.2&lt;/span&gt; Установка&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Gentoo Linux
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;emerge sys-fs/btrfsmaintenance
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="запуск"&gt;&lt;span class="section-num"&gt;5.3&lt;/span&gt; Запуск&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Следует выбрать один из вариантов.&lt;/li&gt;
&lt;li&gt;Обновление таймеров через &lt;em&gt;systemd&lt;/em&gt; (при каждой загрузке системы):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;systemctl &lt;span class="nb"&gt;enable&lt;/span&gt; --now btrfsmaintenance-refresh.path
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Ручное обновление таймеров через &lt;em&gt;systemd&lt;/em&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh systemd-timer
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Ручное обновление таблиц через &lt;em&gt;crond&lt;/em&gt; (без &lt;em&gt;systemd&lt;/em&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="удаление"&gt;&lt;span class="section-num"&gt;5.4&lt;/span&gt; Удаление&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Данные действия выполняют обычно менеджеры пакетов.&lt;/li&gt;
&lt;li&gt;Для удаления всех таймеров запустите:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh uninstall
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="фалы-конфигурации"&gt;&lt;span class="section-num"&gt;5.5&lt;/span&gt; Фалы конфигурации&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;В зависимости от дистрибутива конфигурация может находиться в следующих файлах:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/etc/sysconfig/btrfsmaintenance&lt;/code&gt;: RedHat, SUSE и производные;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/default/btrfsmaintenance&lt;/code&gt;: Debian и производные, Gentoo.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;В качестве шаблона для этих файлов используется &lt;code&gt;sysconfig.btrfsmaintenance&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Подтома btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</link><pubDate>Fri, 27 Aug 2021 11:41:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</guid><description>&lt;p&gt;Подтома (subvolumes) btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#именование-подтомов"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Именование подтомов&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#список-подтомов"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Список подтомов&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#минимально-рекомендуемый-набор-подтомов"&gt;&lt;span class="section-num"&gt;1.2&lt;/span&gt; Минимально рекомендуемый набор подтомов&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#создание-подтомов"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Создание подтомов&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#отключение-cow"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Отключение CoW&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#монтирование-подтомов-в-fstab"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Монтирование подтомов в fstab&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#создание-нового-подтома"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Создание нового подтома&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="именование-подтомов"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Именование подтомов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Для определённости я называю подтома по шаблону &lt;code&gt;@имя_подтома&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="список-подтомов"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Список подтомов&lt;/h3&gt;
&lt;div class="table-caption"&gt;
&lt;span class="table-number"&gt;&amp;#1058;&amp;#1072;&amp;#1073;&amp;#1083;&amp;#1080;&amp;#1094;&amp;#1072; 1:&lt;/span&gt;
Возможные наименования подтомов btrfs
&lt;/div&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Подтом&lt;/th&gt;
&lt;th&gt;Точка монтирования&lt;/th&gt;
&lt;th&gt;Описание&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Корневой каталог (системные файлы)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Домашний каталог с пользовательскими данными&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@root&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/root&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Домашний каталог пользователя &lt;code&gt;root&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;‒&lt;/td&gt;
&lt;td&gt;Корневой подтом для снапшотов&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots@root&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/.snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит снапшоты корня, которые создает &lt;code&gt;snapper&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots@home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/home/.snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит снапшоты домашнего каталога, которые создает &lt;code&gt;snapper&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@machines&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/machines&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Если не существует, то создаст systemd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@portables&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/portables&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Если не существует, то создаст systemd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@docker&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/docker&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Докер создаёт подтома в &lt;code&gt;./btrfs/subvolumes&lt;/code&gt; либо в &lt;code&gt;./XXX/btrfs/subvolumes&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Аналогично выше описанному&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var@lib&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Вместо создания &lt;code&gt;@machines&lt;/code&gt;, &lt;code&gt;@portables&lt;/code&gt;, &lt;code&gt;@docker&lt;/code&gt; можно создать только этот, если в &lt;code&gt;/var/lib&lt;/code&gt; не будет храниться чего-то важного&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var@tmp&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/tmp&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит временные файлы. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var@log&lt;/code&gt; или &lt;code&gt;@log&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/log&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит большое количество файлов, которые пишутся маленькими частями. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@swap&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/swap&lt;/code&gt; или &lt;code&gt;/var/swap&lt;/code&gt;, или &lt;code&gt;/var/lib/swap&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Подтом для файла подкачки. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt; (см.
)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@libvirt&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Образы для &lt;em&gt;libvirt&lt;/em&gt;. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="минимально-рекомендуемый-набор-подтомов"&gt;&lt;span class="section-num"&gt;1.2&lt;/span&gt; Минимально рекомендуемый набор подтомов&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Минимум нужны два подтома: &lt;code&gt;@&lt;/code&gt; и &lt;code&gt;@home&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="создание-подтомов"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Создание подтомов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При установки системы я создаю подтома следующим образом:
&lt;ul&gt;
&lt;li&gt;Подмонтируем раздел с btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/gentoo
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9 /dev/sdc2 /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим подтома на btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var@tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var@log
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @vm
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage@local
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage@com
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @libvirt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @home
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="отключение-cow"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Отключение CoW&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write).&lt;/li&gt;
&lt;li&gt;Так же стоит отключить &lt;em&gt;CoW&lt;/em&gt; для часто изменяемых файлов (например, журналов).&lt;/li&gt;
&lt;li&gt;Подмонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@vm /dev/sdc2 /mnt/gentoo/var/vm
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@libvirt /dev/sdc2 /mnt/gentoo/var/lib/libvirt/images
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var@log /dev/sdc2 /mnt/gentoo/var/log
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отключим для этого подтома CoW:
&lt;ul&gt;
&lt;li&gt;Для &lt;code&gt;/var/vm&lt;/code&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C vm
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Для &lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/lib/libvirt/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C images
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Для &lt;code&gt;/var/log&lt;/code&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C log
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Для &lt;code&gt;/var/tmp&lt;/code&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C tmp
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Посмотреть результат можно командой:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;lsattr -a /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="монтирование-подтомов-в-fstab"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Монтирование подтомов в fstab&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При монтировании я указываю универсальный идентификатор (UUID) файловой системы:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;# /etc/fstab&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;tmp&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;var_tmp&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;usr&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;usr&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;share&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage_local&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage_com&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;libvirt&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;images&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;libvirt&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Идентификатор файловой системы можно узнать следующим образом:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;blkid /dev/sdc2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="создание-нового-подтома"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Создание нового подтома&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;После установки системы может возникнуть необходимость создания дополнительных подтомов на существующем томе.
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/btrfs
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount &lt;span class="nv"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;f8963df3-1320-4bc0-a125-62be185b029e /mnt/btrfs
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvolume create /mnt/btrfs/@data
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подключим в &lt;code&gt;/etc/fstab&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span&gt; /data btrfs relatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@data &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Файловая система btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</link><pubDate>Fri, 27 Aug 2021 11:33:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</guid><description>&lt;p&gt;Файловая система &lt;em&gt;Btrfs&lt;/em&gt;.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#свойства"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Свойства&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#опции-монтирования"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Опции монтирования&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#ssd-trim"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; SSD TRIM&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#разное"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Разное&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#обслуживание-btrfs"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Обслуживание btrfs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#необходимое-программное-обеспечение"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Необходимое программное обеспечение&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#btrfs-progs"&gt;&lt;span class="section-num"&gt;5.1&lt;/span&gt; btrfs-progs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#btrfsmaintenance"&gt;&lt;span class="section-num"&gt;5.2&lt;/span&gt; btrfsmaintenance&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#snapper"&gt;&lt;span class="section-num"&gt;5.3&lt;/span&gt; snapper&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#ресурсы"&gt;&lt;span class="section-num"&gt;6&lt;/span&gt; Ресурсы&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="общая-информация"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;h3 id="свойства"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Свойства&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Копирование при записи (copy on write &amp;mdash; CoW).
&lt;ul&gt;
&lt;li&gt;Все копии файла суммарно занимают на диске столько же места сколько оригинал, а при изменениях файлов данные всегда пишутся в новые страницы.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Снапшоты.
&lt;ul&gt;
&lt;li&gt;Можно делать снимки состояния подтома на лету, а потом вернуть это состояние, например, после неудачного обновления или удаления чего-то нужного, просто отредактировав &lt;code&gt;/etc/fstab&lt;/code&gt; и выполнив &lt;code&gt;mount -o remount mountpoint&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Для автоматического создания снапшотов можно использовать утилиту &lt;code&gt;snapper&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Поддержка сжатия.&lt;/li&gt;
&lt;li&gt;Поддержка подтомов.
&lt;ul&gt;
&lt;li&gt;Вместо разделов предпочтительно использовать подтома.&lt;/li&gt;
&lt;li&gt;Подтома имеют динамический размер.&lt;/li&gt;
&lt;li&gt;Снапшоты являются по сути подтомами.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Поддержка дисков SSD.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="опции-монтирования"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Опции монтирования&lt;/h2&gt;
&lt;h3 id="ssd-trim"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; SSD TRIM&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Файловая система Btrfs может освобождать неиспользуемые блоки с SSD диска, поддерживающего команду TRIM.&lt;/li&gt;
&lt;li&gt;Поддерживается асинхронный discard, который доступен в виде опции монтирования &lt;code&gt;discard=async&lt;/code&gt;.
&lt;ul&gt;
&lt;li&gt;Включено по умолчанию начиная с linux 6.2.&lt;/li&gt;
&lt;li&gt;Незанятые экстенты не освобождаются сразу, а группируются и освобождаются позже в отдельном потоке, что улучшает задержки при записи на диск.&lt;/li&gt;
&lt;li&gt;Асинхронный discard можно безопасно использовать вместе с периодическим TRIM.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="разное"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Разное&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="обслуживание-btrfs"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Обслуживание btrfs&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="необходимое-программное-обеспечение"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Необходимое программное обеспечение&lt;/h2&gt;
&lt;h3 id="btrfs-progs"&gt;&lt;span class="section-num"&gt;5.1&lt;/span&gt; btrfs-progs&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Утилиты для работы с &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;Gentoo
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;emerge sys-fs/btrfs-progs
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="btrfsmaintenance"&gt;&lt;span class="section-num"&gt;5.2&lt;/span&gt; btrfsmaintenance&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Скрипт для регулярного обслуживания файловой системы &lt;em&gt;btrfs&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;Gentoo
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;emerge sys-fs/btrfsmaintenance
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="snapper"&gt;&lt;span class="section-num"&gt;5.3&lt;/span&gt; snapper&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Управление снапшотами&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;Gentoo
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;emerge app-backup/snapper
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="ресурсы"&gt;&lt;span class="section-num"&gt;6&lt;/span&gt; Ресурсы&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Документация:
&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Перенос Linux на btrfs</title><link>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</link><pubDate>Fri, 21 May 2021 20:38:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</guid><description>&lt;p&gt;Перенос Gentoo Linux с одного диска на другой. На новом диске делается система btrfs.&lt;/p&gt;
&lt;details class="print:hidden xl:hidden" &gt;
&lt;summary&gt;Содержание&lt;/summary&gt;
&lt;div class="text-sm"&gt;
&lt;nav id="TableOfContents"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#исходное-состояние-системы"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Исходное состояние системы&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#система-на-lvm"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Система на LVM&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#система-на-btrfs"&gt;&lt;span class="section-num"&gt;1.2&lt;/span&gt; Система на btrfs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#разбиение-диска"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Разбиение диска&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#выделенная-boot-партиция"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; Выделенная boot-партиция&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#все-разделы-на-файловой-системе-btrfs"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; Все разделы на файловой системе btrfs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#подготовка-раздела-с-btrfs"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Подготовка раздела с btrfs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#копирование-существующих-файловых-систем"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Копирование существующих файловых систем&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#система-на-lvm"&gt;&lt;span class="section-num"&gt;4.1&lt;/span&gt; Система на LVM&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#система-на-btrfs"&gt;&lt;span class="section-num"&gt;4.2&lt;/span&gt; Система на btrfs&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#подготовка-к-копированию"&gt;&lt;span class="section-num"&gt;4.2.1&lt;/span&gt; Подготовка к копированию&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#копирование-основных-файловых-систем"&gt;&lt;span class="section-num"&gt;4.2.2&lt;/span&gt; Копирование основных файловых систем&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#копируем-portage"&gt;&lt;span class="section-num"&gt;4.2.3&lt;/span&gt; Копируем portage&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#копируем-системы-с-отключением-cow"&gt;&lt;span class="section-num"&gt;4.2.4&lt;/span&gt; Копируем системы с отключением CoW&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#установка-загрузчика"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Установка загрузчика&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#файл-монтирования-fstab"&gt;&lt;span class="section-num"&gt;6&lt;/span&gt; Файл монтирования fstab&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#файл-подкачки-на-файловой-системе-btrfs"&gt;&lt;span class="section-num"&gt;7&lt;/span&gt; Файл подкачки на файловой системе btrfs&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#подготовка-к-созданию-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.1&lt;/span&gt; Подготовка к созданию файла подкачки&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#создание-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.2&lt;/span&gt; Создание файла подкачки&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#старый-подход"&gt;&lt;span class="section-num"&gt;7.2.1&lt;/span&gt; Старый подход&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#новый-подход"&gt;&lt;span class="section-num"&gt;7.2.2&lt;/span&gt; Новый подход&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#активация-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.3&lt;/span&gt; Активация файла подкачки&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
&lt;/details&gt;
&lt;h2 id="исходное-состояние-системы"&gt;&lt;span class="section-num"&gt;1&lt;/span&gt; Исходное состояние системы&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Переносил несколько вариантов исходных систем.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="система-на-lvm"&gt;&lt;span class="section-num"&gt;1.1&lt;/span&gt; Система на LVM&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Исходно система установлена на LVM:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/dev/sda1&lt;/code&gt;: &lt;code&gt;/boot/EFI&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/sda2&lt;/code&gt;: &lt;code&gt;/boot&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/root&lt;/code&gt;: &lt;code&gt;/&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/var&lt;/code&gt;: &lt;code&gt;/var&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/var_tmp&lt;/code&gt;: &lt;code&gt;/var/tmp&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/vm&lt;/code&gt;: &lt;code&gt;/var/vm&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage&lt;/code&gt;: &lt;code&gt;/usr/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage_local&lt;/code&gt;: &lt;code&gt;/usr/local/share/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage_com&lt;/code&gt;: &lt;code&gt;/com/lib/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/home&lt;/code&gt;: &lt;code&gt;/home&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="система-на-btrfs"&gt;&lt;span class="section-num"&gt;1.2&lt;/span&gt; Система на btrfs&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Система на btrfs:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/dev/sda1&lt;/code&gt;: &lt;code&gt;/boot/EFI&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/sda2&lt;/code&gt;: &lt;code&gt;/boot&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/sda3&lt;/code&gt;: &lt;code&gt;swap&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/sda4&lt;/code&gt;: партиция с файловой системой btrfs.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="разбиение-диска"&gt;&lt;span class="section-num"&gt;2&lt;/span&gt; Разбиение диска&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Установим тип разбиения в GPT.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="выделенная-boot-партиция"&gt;&lt;span class="section-num"&gt;2.1&lt;/span&gt; Выделенная boot-партиция&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Разобьём на партиции:
&lt;ul&gt;
&lt;li&gt;p1 &amp;mdash; 512M, для &lt;code&gt;EFI&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;p2 &amp;mdash; 500&amp;ndash;1024M, для &lt;code&gt;/boot&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;p3 &amp;mdash; двойная оперативная память, для &lt;code&gt;swap&lt;/code&gt;.
&lt;ul&gt;
&lt;li&gt;Также можно разместить файл подкачки на &lt;code&gt;btrfs&lt;/code&gt; (см.
).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;p4 &amp;mdash; всё остальное для &lt;code&gt;btrfs&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Создадим файловые системы:
&lt;ul&gt;
&lt;li&gt;p1 (&lt;code&gt;EFI&lt;/code&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkfs.vfat -F32 -n EFI /dev/sdc1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;p2 (&lt;code&gt;/boot&lt;/code&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkfs.ext4 -L boot /dev/sdc2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;p3 (&lt;code&gt;swap&lt;/code&gt; в случае отдельной партиции):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkswap -L swap /dev/sdc3
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;p4 (&lt;code&gt;btrfs&lt;/code&gt;)
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkfs.btrfs /dev/sdc4
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="все-разделы-на-файловой-системе-btrfs"&gt;&lt;span class="section-num"&gt;2.2&lt;/span&gt; Все разделы на файловой системе btrfs&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Разобьём на партиции:
&lt;ul&gt;
&lt;li&gt;p1 &amp;mdash; 1024M, для &lt;code&gt;EFI&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Файл подкачки на &lt;code&gt;btrfs&lt;/code&gt; (см.
).&lt;/li&gt;
&lt;li&gt;p4 &amp;mdash; всё остальное для &lt;code&gt;btrfs&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Разобьём диск:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sgdisk -n 0:0:+1024M -t 0:ef00 -c 0:EFI /dev/sdc
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sgdisk -n 0:0:0 -t 0:8300 -c 0:gentoo /dev/sdc
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим файловые системы:
&lt;ul&gt;
&lt;li&gt;p1 (&lt;code&gt;EFI&lt;/code&gt;):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkfs.vfat -F32 -n EFI /dev/sdc1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;p2 (&lt;code&gt;btrfs&lt;/code&gt;) (см.
):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkfs.btrfs --checksum blake2 -L gentoo /dev/sdc2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="подготовка-раздела-с-btrfs"&gt;&lt;span class="section-num"&gt;3&lt;/span&gt; Подготовка раздела с btrfs&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Подмонтируем раздел с btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/to
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9 /dev/sdc2 /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим подтома на btrfs (см.
):
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var@tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @var@log
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @vm
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @home
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @root
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @libvirt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подтома для &lt;em&gt;Gentoo Linux&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Используется, если &lt;em&gt;portage&lt;/em&gt; размещается локально:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage@local
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @portage@com
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Если используется файл подкачки на файловой системе, то создадим для него подтом:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs subvol create @swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="копирование-существующих-файловых-систем"&gt;&lt;span class="section-num"&gt;4&lt;/span&gt; Копирование существующих файловых систем&lt;/h2&gt;
&lt;h3 id="система-на-lvm"&gt;&lt;span class="section-num"&gt;4.1&lt;/span&gt; Система на LVM&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Создадим точку монтирования:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/from
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем root-партицию:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/vgs/root /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/ /mnt/to/@
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;/var&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/vgs/var /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/ /mnt/to/@var
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;/boot&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sdc2 /mnt/to
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sdb2 /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/ /mnt/to/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/to
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/from
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;portage&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/vgs/portage /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/ /mnt/to/@portage
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;portage_local&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/vgs/portage_local /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/ /mnt/to/@portage_local
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="система-на-btrfs"&gt;&lt;span class="section-num"&gt;4.2&lt;/span&gt; Система на btrfs&lt;/h3&gt;
&lt;h4 id="подготовка-к-копированию"&gt;&lt;span class="section-num"&gt;4.2.1&lt;/span&gt; Подготовка к копированию&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Создадим точки монтирования:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir -p /mnt/from
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем исходную файловую систему btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sda4 /mnt/from/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="копирование-основных-файловых-систем"&gt;&lt;span class="section-num"&gt;4.2.2&lt;/span&gt; Копирование основных файловых систем&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Скопируем root-партицию:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS -AX --delete /mnt/from/@/* /mnt/to/@
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Скопируем &lt;code&gt;/var&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS -AX --delete /mnt/from/@var/* /mnt/to/@var
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;/boot&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sda2 /mnt/boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/boot/* /mnt/to/@boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;umount /mnt/boot
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="копируем-portage"&gt;&lt;span class="section-num"&gt;4.2.3&lt;/span&gt; Копируем portage&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Если &lt;code&gt;portage&lt;/code&gt; размещён локально, то его тоже надо скопировать.&lt;/li&gt;
&lt;li&gt;Скопируем &lt;code&gt;@portage&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;!--listend--&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/@portage/* /mnt/to/@portage
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Скопируем &lt;code&gt;@portage@local&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;!--listend--&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS --delete /mnt/from/@portage@local/* /mnt/to/@portage@local
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="копируем-системы-с-отключением-cow"&gt;&lt;span class="section-num"&gt;4.2.4&lt;/span&gt; Копируем системы с отключением CoW&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write) (см.
).&lt;/li&gt;
&lt;li&gt;Так же стоит отключить &lt;em&gt;CoW&lt;/em&gt; для часто изменяемых файлов (например, журналов).&lt;/li&gt;
&lt;li&gt;Подмонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir -p /mnt/gentoo
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@ /dev/sdc2 /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var /dev/sdc2 /mnt/gentoo/var
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@vm /dev/sdc2 /mnt/gentoo/var/vm
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@libvirt /dev/sdc2 /mnt/gentoo/var/lib/libvirt/images
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var@log /dev/sdc2 /mnt/gentoo/var/log
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!--list-separator--&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Копирование &lt;code&gt;/var/vm&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Отключим для этого подтома CoW:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C vm
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Скопируем &lt;code&gt;/var/vm&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS -AX --delete /mnt/from/@vm/* /mnt/to/@vm
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;!--list-separator--&gt;
&lt;ol start="2"&gt;
&lt;li&gt;
&lt;p&gt;Копирование &lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Отключим для подтома &lt;code&gt;/var/lib/libvirt/images&lt;/code&gt; CoW:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/lib/libvirt/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C images
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Скопируем &lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS -AX --delete /mnt/from/@libvirt/* /mnt/to/@libvirt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;!--list-separator--&gt;
&lt;ol start="3"&gt;
&lt;li&gt;
&lt;p&gt;Копирование &lt;code&gt;/var/log&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Для &lt;code&gt;/var/log&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Отключим для подтома &lt;code&gt;/var/log&lt;/code&gt; CoW:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C log
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Скопируем &lt;code&gt;/var/log&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rsync -av -HS -AX --delete /mnt/from/@var@log/* /mnt/to/@var@log
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;!--list-separator--&gt;
&lt;ol start="4"&gt;
&lt;li&gt;
&lt;p&gt;Настройки &lt;code&gt;/var/tmp&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Для &lt;code&gt;/var/tmp&lt;/code&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C tmp
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Посмотреть результат можно командой:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;lsattr -a /mnt/gentoo/var/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="установка-загрузчика"&gt;&lt;span class="section-num"&gt;5&lt;/span&gt; Установка загрузчика&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Перемонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir -p /mnt/gentoo
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@ /dev/sdc2 /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var /dev/sdc2 /mnt/gentoo/var
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard&lt;span class="o"&gt;=&lt;/span&gt;async,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@boot /dev/sdc2 /mnt/gentoo/boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount /dev/sdc1 /mnt/gentoo/boot/efi
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем псевдо-файловые системы:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o &lt;span class="nb"&gt;bind&lt;/span&gt; /dev /mnt/gentoo/dev/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o &lt;span class="nb"&gt;bind&lt;/span&gt; /proc /mnt/gentoo/proc/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o &lt;span class="nb"&gt;bind&lt;/span&gt; /sys /mnt/gentoo/sys/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -o &lt;span class="nb"&gt;bind&lt;/span&gt; /run /mnt/gentoo/run/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -t efivarfs efivarfs /mnt/gentoo/sys/firmware/efi/efivars
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Установим загрузчик:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chroot /mnt/gentoo/ /bin/bash
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;grub-install /boot
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;grub-mkconfig -o /boot/grub/grub.cfg
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="файл-монтирования-fstab"&gt;&lt;span class="section-num"&gt;6&lt;/span&gt; Файл монтирования fstab&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Создадим файл монтирования fstab.&lt;/li&gt;
&lt;li&gt;Узнаем идентификатор партиции с файловой системой btrfs:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;blkid /dev/sdc2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Получим строчку:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nv"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим файл &lt;code&gt;/mnt/to/etc/fstab&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;LABEL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;boot&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;boot&lt;/span&gt; &lt;span class="n"&gt;ext4&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;LABEL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;EFI&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;boot&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;efi&lt;/span&gt; &lt;span class="n"&gt;vfat&lt;/span&gt; &lt;span class="n"&gt;defaults&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;flush&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;tz&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;UTC&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;LABEL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;swap&amp;#34;&lt;/span&gt; &lt;span class="n"&gt;none&lt;/span&gt; &lt;span class="n"&gt;swap&lt;/span&gt; &lt;span class="n"&gt;sw&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;tmp&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;var_tmp&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;usr&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;usr&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;share&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage_local&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;portage&lt;/span&gt; &lt;span class="n"&gt;btrfs&lt;/span&gt; &lt;span class="n"&gt;relatime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;async&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;autodefrag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;zstd&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;subvol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;portage_com&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Если используется файл подкачки, то вместо отдельной партиции следует подключить этот файл в &lt;code&gt;/mnt/to/etc/fstab&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;UUID=&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34; /swap btrfs relatime,discard=async,autodefrag,compress=zstd:9,subvol=@swap 0 0
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/swap/swapfile none swap sw 0 0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="файл-подкачки-на-файловой-системе-btrfs"&gt;&lt;span class="section-num"&gt;7&lt;/span&gt; Файл подкачки на файловой системе btrfs&lt;/h2&gt;
&lt;h3 id="подготовка-к-созданию-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.1&lt;/span&gt; Подготовка к созданию файла подкачки&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Для раздела файла подкачки следует отключить CoW (copy-on-write).&lt;/li&gt;
&lt;li&gt;Подмонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir -p /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@ /dev/sdc2 /mnt/gentoo/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим точку монтирования:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkdir /mnt/gentoo/swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Подмонтируем подтом &lt;code&gt;@swap&lt;/code&gt;:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mount -tbtrfs -orelatime,discard,autodefrag,compress&lt;span class="o"&gt;=&lt;/span&gt;zstd:9,subvol&lt;span class="o"&gt;=&lt;/span&gt;@swap /dev/sdc2 /mnt/gentoo/swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отключим для этого подтома CoW:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chattr +C /mnt/gentoo/swap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="создание-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.2&lt;/span&gt; Создание файла подкачки&lt;/h3&gt;
&lt;h4 id="старый-подход"&gt;&lt;span class="section-num"&gt;7.2.1&lt;/span&gt; Старый подход&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Создадим файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;truncate -s &lt;span class="m"&gt;0&lt;/span&gt; /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Установим права доступа &lt;code&gt;600&lt;/code&gt; к файлу подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;chmod &lt;span class="m"&gt;600&lt;/span&gt; /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Установим размер файла подкачки исходя из размера оперативной памяти:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;fallocate -l &lt;span class="k"&gt;$(&lt;/span&gt;free -h --si &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt; /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Отформатируем файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;mkswap /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="новый-подход"&gt;&lt;span class="section-num"&gt;7.2.2&lt;/span&gt; Новый подход&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Работает начиная с версии утилит 6.1.&lt;/li&gt;
&lt;li&gt;Создадим файл подкачки размером 8ГБ:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs filesystem mkswapfile --size 4g --uuid clear /mnt/gentooswap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Создадим файл подкачки исходя из размера оперативной памяти:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;btrfs filesystem mkswapfile --size &lt;span class="k"&gt;$(&lt;/span&gt;free -h --si &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt; --uuid clear /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="активация-файла-подкачки"&gt;&lt;span class="section-num"&gt;7.3&lt;/span&gt; Активация файла подкачки&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Активируем файл подкачки:
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;swapon /mnt/gentoo/swap/swapfile
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>