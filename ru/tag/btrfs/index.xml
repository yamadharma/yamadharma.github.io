<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>btrfs | Д. С. Кулябов</title>
    <link>https://yamadharma.github.io/ru/tag/btrfs/</link>
      <atom:link href="https://yamadharma.github.io/ru/tag/btrfs/index.xml" rel="self" type="application/rss+xml" />
    <description>btrfs</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>ru-ru</language><copyright>© 2023 Dmitry S. Kulyabov</copyright><lastBuildDate>Sat, 28 May 2022 14:51:00 +0300</lastBuildDate>
    <image>
      <url>https://yamadharma.github.io/media/icon_hu0a661dd90139895e92e2f18ae9404407_611148_512x512_fill_lanczos_center_3.png</url>
      <title>btrfs</title>
      <link>https://yamadharma.github.io/ru/tag/btrfs/</link>
    </image>
    
    <item>
      <title>Дедупликация btrfs. Bees</title>
      <link>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</link>
      <pubDate>Sat, 28 May 2022 14:51:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</guid>
      <description>&lt;p&gt;BEES (Best-Effort Extent-Same) &amp;mdash; агент дедупликации &lt;em&gt;btrfs&lt;/em&gt;.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#плюсы-и-минусы&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Плюсы и минусы&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#сильные-стороны&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.1&lt;/span&gt; Сильные стороны&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#слабые-стороны&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.2&lt;/span&gt; Слабые стороны&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#установка&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Установка&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#использование&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Использование&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#запуск&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4.1&lt;/span&gt; Запуск&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#конфигурация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4.2&lt;/span&gt; Конфигурация&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Репозиторий: &lt;a href=&#34;https://github.com/Zygo/bees&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/Zygo/bees&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Сайт: &lt;a href=&#34;https://zygo.github.io/bees/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://zygo.github.io/bees/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Уровень дедупликации: блочный.&lt;/li&gt;
&lt;li&gt;Работает как демон.&lt;/li&gt;
&lt;li&gt;Поддерживается инкрементное сканирование данных.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;плюсы-и-минусы&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Плюсы и минусы&lt;/h2&gt;
&lt;h3 id=&#34;сильные-стороны&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.1&lt;/span&gt; Сильные стороны&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Хеш-таблица с эффективным использованием места, можно использовать всего 1 ГБ хеш-таблицы на 10 ТБ уникальных данных.&lt;/li&gt;
&lt;li&gt;Демон постепенно выполняет дедупликацию новых данных, используя поиск по дереву btrfs.&lt;/li&gt;
&lt;li&gt;Поддержка сжатия btrfs, дедупликация комбинации сжатых и несжатых файлов.&lt;/li&gt;
&lt;li&gt;Постоянная хеш-таблица для быстрого перезапуска после выключения.&lt;/li&gt;
&lt;li&gt;Дедупликация всей файловой системы, включая моментальные снимки.&lt;/li&gt;
&lt;li&gt;Постоянный размер хеш-таблицы: использование оперативной памяти не увеличивается, если набор данных становится больше.&lt;/li&gt;
&lt;li&gt;Автоматическое саморегулирование в зависимости от загрузки системы.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;слабые-стороны&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.2&lt;/span&gt; Слабые стороны&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Дедупликация только всей файловой системы.&lt;/li&gt;
&lt;li&gt;Требуются привилегии &lt;code&gt;root&lt;/code&gt; (или &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Первый запуск может увеличить использование пространства метаданных, если существует много моментальных снимков.&lt;/li&gt;
&lt;li&gt;Постоянный размер хеш-таблицы: использование оперативной памяти не уменьшается, если набор данных становится меньше.&lt;/li&gt;
&lt;li&gt;Работает только с &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;установка&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Установка&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Gentoo:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;emerge bees
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;использование&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Использование&lt;/h2&gt;
&lt;h3 id=&#34;запуск&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4.1&lt;/span&gt; Запуск&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Для запуска используем скрипт &lt;code&gt;beesd&lt;/code&gt; (в исходниках &lt;code&gt;scripts/beesd&lt;/code&gt;).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Посмотрим идентификаторы &lt;code&gt;UUID&lt;/code&gt; файловых систем:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;btrfs filesystem show
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Активируем демон дедупликации, указав &lt;code&gt;UUID&lt;/code&gt; в качестве идентификатора инстанса. Пусть &lt;code&gt;UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code&gt;, тогда команда активации будет иметь вид:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;systemctl enable --now beesd@f8963df3-1320-4bc0-a125-62be185b029e
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;конфигурация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4.2&lt;/span&gt; Конфигурация&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Для работы демона необходим файл конфигурации.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Шаблон для файла конфигурации:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/etc/bees/beesd.conf.sample
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Скопируйте его, задав произвольное имя (например, &lt;code&gt;root.conf&lt;/code&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cp /etc/bees/beesd.conf.sample /etc/bees/root.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;В этом файле задайте поле &lt;code&gt;UUID&lt;/code&gt; с необходимым значение.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Для запуска необходимо наличие файла с расширением &lt;code&gt;.conf&lt;/code&gt; и поля &lt;code&gt;UUID&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Остальные поля конфигурации настраиваются по желанию. В противном случае используются значения по умолчанию.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Дедупликация файловой системы btrfs</title>
      <link>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</link>
      <pubDate>Thu, 26 May 2022 14:29:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</guid>
      <description>&lt;p&gt;Дедупликация файловой системы btrfs.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#реализация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Реализация&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#duperemove&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.1&lt;/span&gt; duperemove&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#bees&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.2&lt;/span&gt; bees&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#bedup&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.3&lt;/span&gt; bedup&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#btrfs-dedup&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.4&lt;/span&gt; btrfs-dedup&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#дедупликация-на-уровне-файлов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Дедупликация на уровне файлов&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При дедупликации идентифицируются блоки данных, которые имеют общие последовательности.&lt;/li&gt;
&lt;li&gt;Они объединяются в один экстент с семантикой копирования при записи.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;реализация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Реализация&lt;/h2&gt;
&lt;h3 id=&#34;duperemove&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.1&lt;/span&gt; duperemove&lt;/h3&gt;
&lt;h3 id=&#34;bees&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.2&lt;/span&gt; bees&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/&#34;&gt;Дедупликация btrfs. Bees&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Уровень дедупликации: блочный.&lt;/li&gt;
&lt;li&gt;Работает как демон.&lt;/li&gt;
&lt;li&gt;Использую для дедупликации файловой системы.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;bedup&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.3&lt;/span&gt; bedup&lt;/h3&gt;
&lt;h3 id=&#34;btrfs-dedup&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2.4&lt;/span&gt; btrfs-dedup&lt;/h3&gt;
&lt;h2 id=&#34;дедупликация-на-уровне-файлов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Дедупликация на уровне файлов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Некоторые утилиты для дедупликации на уровне файлов поддерживают файловую систему &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Обслуживание btrfs</title>
      <link>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</link>
      <pubDate>Thu, 23 Sep 2021 10:22:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</guid>
      <description>&lt;p&gt;Действия по обслуживанию Btrfs.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#скрипт-btrfsmaintenance&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Скрипт btrfsmaintenance&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Общая информация&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#установка&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.2&lt;/span&gt; Установка&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#запуск&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.3&lt;/span&gt; Запуск&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#удаление&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.4&lt;/span&gt; Удаление&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#фалы-конфигурации&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.5&lt;/span&gt; Фалы конфигурации&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;скрипт-btrfsmaintenance&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Скрипт btrfsmaintenance&lt;/h2&gt;
&lt;h3 id=&#34;общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Общая информация&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Выполняемые действия:
&lt;ul&gt;
&lt;li&gt;периодическая проверка целостности;&lt;/li&gt;
&lt;li&gt;периодическая балансировка;&lt;/li&gt;
&lt;li&gt;периодический trim для SSD;&lt;/li&gt;
&lt;li&gt;периодическая дефрагментация.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Репозиторий: &lt;a href=&#34;https://github.com/kdave/btrfsmaintenance&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/kdave/btrfsmaintenance&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;установка&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.2&lt;/span&gt; Установка&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Google&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;emerge sys-fs/btrfsmaintenance
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;запуск&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.3&lt;/span&gt; Запуск&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Данные действия выполняют обычно менеджеры пакетов.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Обновление таймеров через &lt;em&gt;systemd&lt;/em&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh systemd-timer
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Обновление таблиц &lt;em&gt;crond&lt;/em&gt; (без &lt;em&gt;systemd&lt;/em&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;удаление&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.4&lt;/span&gt; Удаление&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Данные действия выполняют обычно менеджеры пакетов.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Для удаления всех таймеров запустите:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh uninstall
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;фалы-конфигурации&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.5&lt;/span&gt; Фалы конфигурации&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;В зависимости от дистрибутива конфигурация может находиться в следующих файлах:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/etc/sysconfig/btrfsmaintenance&lt;/code&gt;: RedHat, SUSE и производные;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/default/btrfsmaintenance&lt;/code&gt;: Debian и производные, Gentoo.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;В качестве шаблона для этих файлов используется &lt;code&gt;sysconfig.btrfsmaintenance&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Подтома btrfs</title>
      <link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</link>
      <pubDate>Fri, 27 Aug 2021 11:41:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</guid>
      <description>&lt;p&gt;Подтома (subvolumes) btrfs.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#именование-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Именование подтомов&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#список-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Список подтомов&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#минимально-рекомендуемый-набор-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.2&lt;/span&gt; Минимально рекомендуемый набор подтомов&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#создание-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Создание подтомов&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#отключение-cow&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Отключение CoW&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#монтирование-подтомов-в-fstab&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Монтирование подтомов в fstab&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#создание-нового-подтома&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;5&lt;/span&gt; Создание нового подтома&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;именование-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Именование подтомов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Для определённости я называю подтома по шаблону &lt;code&gt;@имя_подтома&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;список-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Список подтомов&lt;/h3&gt;
&lt;div class=&#34;table-caption&#34;&gt;
  &lt;span class=&#34;table-number&#34;&gt;&amp;#1058;&amp;#1072;&amp;#1073;&amp;#1083;&amp;#1080;&amp;#1094;&amp;#1072; 1:&lt;/span&gt;
  Возможные наименования подтомов btrfs
&lt;/div&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Подтом&lt;/th&gt;
&lt;th&gt;Точка монтирования&lt;/th&gt;
&lt;th&gt;Описание&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Корневой каталог (системные файлы)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Домашний каталог с пользовательскими данными&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;‒&lt;/td&gt;
&lt;td&gt;Корневой подтом для снапшотов&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots/root&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/.snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит снапшоты корня, которые создает snapper&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@snapshots/home&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/home/.snapshots&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит снапшоты хомяка, которые создает snapper&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@machines&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/machines&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Если не существует, то создаст systemd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@portables&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/portables&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Если не существует, то создаст systemd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@docker&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/docker&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Докер создаёт подтома в &lt;code&gt;./btrfs/subvolumes&lt;/code&gt; либо в &lt;code&gt;./XXX/btrfs/subvolumes&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Аналогично выше описанному&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var_lib&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Вместо создания &lt;code&gt;@machines&lt;/code&gt;, &lt;code&gt;@portables&lt;/code&gt;, &lt;code&gt;@docker&lt;/code&gt; можно создать только этот, если в &lt;code&gt;/var/lib&lt;/code&gt; не будет храниться чего-то важного&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var_tmp&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/tmp&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит временные файлы. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@var_log&lt;/code&gt; или &lt;code&gt;@log&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/log&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Содержит большое количество файлов, которые пишутся маленькими частями. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@swap&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/swap&lt;/code&gt; или &lt;code&gt;/var/swap&lt;/code&gt;, или &lt;code&gt;/var/lib/swap&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Подтом для файла подкачки. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt; (см. &lt;a href=&#34;https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/&#34;&gt;Файл подкачки на btrfs&lt;/a&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;@libvirt&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Образы для &lt;em&gt;libvirt&lt;/em&gt;. Должен монтироваться с &lt;code&gt;nodatacow&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;минимально-рекомендуемый-набор-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.2&lt;/span&gt; Минимально рекомендуемый набор подтомов&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Минимум нужны два подтома: &lt;code&gt;@&lt;/code&gt; и &lt;code&gt;@home&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;создание-подтомов&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Создание подтомов&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;При установки системы я создаю подтома следующим образом:
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Подмонтируем раздел с btrfs:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkdir /mnt/gentoo
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Создадим подтома на btrfs:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/
btrfs subvol create @
btrfs subvol create @var
btrfs subvol create @var_tmp
btrfs subvol create @var_log
btrfs subvol create @vm
btrfs subvol create @portage
btrfs subvol create @portage_local
btrfs subvol create @portage_com
btrfs subvol create @libvirt
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;отключение-cow&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Отключение CoW&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Так же стоит отключить &lt;em&gt;CoW&lt;/em&gt; для часто изменяемых файлов (например, журналов).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Подмонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@vm /dev/sda4 /mnt/gentoo/var/vm
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@libvirt /dev/sda4 /mnt/gentoo/var/lib/libvirt/images
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@var_log /dev/sda4 /mnt/gentoo/var/log
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Отключим для этого подтома CoW:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Для &lt;code&gt;/var/vm&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/var/
chattr +C vm
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Для &lt;code&gt;/var/lib/libvirt/images&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/var/lib/libvirt/
chattr +C images
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Для &lt;code&gt;/var/log&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/var/
chattr +C log
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Посмотреть результат можно командой:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;lsattr -a /mnt/gentoo/var/
lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;монтирование-подтомов-в-fstab&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Монтирование подтомов в fstab&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;При монтировании я указываю универсальный идентификатор (UUID) файловой системы:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-conf-unix&#34;&gt;# /etc/fstab
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /               btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@    0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /var            btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@var 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /var/tmp        btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp     0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /var/vm         btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@vm          0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /home           btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@home        0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /usr/portage    btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@portage     0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /usr/local/share/portage        btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_local       0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;     /com/lib/portage        btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_com 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;    /var/lib/libvirt/images       btrfs   relatime,discard,autodefrag,compress=zstd:9,subvol=@libvirt 0 0
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Идентификатор файловой системы можно узнать следующим образом:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;blkid /dev/sda4
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;создание-нового-подтома&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;5&lt;/span&gt; Создание нового подтома&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;После установки системы может возникнуть необходимость создания дополнительных подтомов на существующем томе.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkdir /mnt/btrfs
mount UUID=f8963df3-1320-4bc0-a125-62be185b029e /mnt/btrfs
btrfs subvolume create /mnt/btrfs/@data
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Подключим в &lt;code&gt;/etc/fstab&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;	/data		btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@data        0 0
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Файловая система btrfs</title>
      <link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</link>
      <pubDate>Fri, 27 Aug 2021 11:33:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</guid>
      <description>&lt;p&gt;Файловая система &lt;em&gt;Btrfs&lt;/em&gt;.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#свойства&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Свойства&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#разное&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Разное&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#необходимое-программное-обеспечение&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Необходимое программное обеспечение&lt;/a&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;a href=&#34;#btrfs-progs&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.1&lt;/span&gt; btrfs-progs&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#btrfsmaintenance&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.2&lt;/span&gt; btrfsmaintenance&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&#34;#snapper&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.3&lt;/span&gt; snapper&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;общая-информация&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Общая информация&lt;/h2&gt;
&lt;h3 id=&#34;свойства&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1.1&lt;/span&gt; Свойства&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Копирование при записи (copy on write &amp;mdash; CoW).
&lt;ul&gt;
&lt;li&gt;Все копии файла суммарно занимают на диске столько же места сколько оригинал, а при изменениях файлов данные всегда пишутся в новые страницы.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Снапшоты.
&lt;ul&gt;
&lt;li&gt;Можно делать снимки состояния подтома на лету, а потом вернуть это состояние, например, после неудачного обновления или удаления чего-то нужного, просто отредактировав &lt;code&gt;/etc/fstab&lt;/code&gt; и выполнив &lt;code&gt;mount -o remount mountpoint&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Для автоматического создания снапшотов можно использовать утилиту &lt;code&gt;snapper&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Поддержка сжатия.&lt;/li&gt;
&lt;li&gt;Поддержка подтомов.
&lt;ul&gt;
&lt;li&gt;Вместо разделов предпочтительно использовать подтома.&lt;/li&gt;
&lt;li&gt;Подтома имеют динамический размер.&lt;/li&gt;
&lt;li&gt;Снапшоты являются по сути подтомами.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Поддержка дисков SSD.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;разное&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Разное&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/&#34;&gt;Установка Linux на btrfs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/&#34;&gt;Подтома btrfs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/&#34;&gt;Обслуживание btrfs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/&#34;&gt;Дедупликация файловой системы btrfs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;необходимое-программное-обеспечение&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Необходимое программное обеспечение&lt;/h2&gt;
&lt;h3 id=&#34;btrfs-progs&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.1&lt;/span&gt; btrfs-progs&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Утилиты для работы с &lt;em&gt;btrfs&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Gentoo&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;emerge sys-fs/btrfs-progs
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;btrfsmaintenance&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.2&lt;/span&gt; btrfsmaintenance&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Скрипт для регулярного обслуживания файловой системы &lt;em&gt;btrfs&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Gentoo&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;emerge sys-fs/btrfsmaintenance
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;snapper&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3.3&lt;/span&gt; snapper&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Управление снапшотами&lt;/li&gt;
&lt;li&gt;Установка
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Gentoo&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;emerge app-backup/snapper
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Установка Linux на btrfs</title>
      <link>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</link>
      <pubDate>Fri, 21 May 2021 20:38:00 +0300</pubDate>
      <guid>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</guid>
      <description>&lt;p&gt;Перенос Gentoo Linux с одного диска на другой. На новом диске делается система btrfs.&lt;/p&gt;
&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;
  &lt;summary class=&#34;font-weight-bold&#34;&gt;Содержание&lt;/summary&gt;
  &lt;nav id=&#34;TableOfContents&#34;&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href=&#34;#исходное-состояние-системы&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Исходное состояние системы&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#разбиение-диска&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Разбиение диска&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#подготовка-раздела-с-btrfs&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Подготовка раздела с btrfs&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#копирование-существующих-файловых-систем&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Копирование существующих файловых систем&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#установка-загрузчика&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;5&lt;/span&gt; Установка загрузчика&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#создадим-файл-монтирования-fstab&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;6&lt;/span&gt; Создадим файл монтирования fstab&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&#34;#копирование-специальных-файловых-систем&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;7&lt;/span&gt; Копирование специальных файловых систем&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
&lt;/details&gt;

&lt;h2 id=&#34;исходное-состояние-системы&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;1&lt;/span&gt; Исходное состояние системы&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Исходно система установлена на LVM:
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/dev/sdb1&lt;/code&gt;: &lt;code&gt;/boot/EFI&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/sdb2&lt;/code&gt;: &lt;code&gt;/boot&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/root&lt;/code&gt;: &lt;code&gt;/&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/var&lt;/code&gt;: &lt;code&gt;/var&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/var_tmp&lt;/code&gt;: &lt;code&gt;/var/tmp&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/vm&lt;/code&gt;: &lt;code&gt;/var/vm&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage&lt;/code&gt;: &lt;code&gt;/usr/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage_local&lt;/code&gt;: &lt;code&gt;/usr/local/share/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/portage_com&lt;/code&gt;: &lt;code&gt;/com/lib/portage&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/vgs/home&lt;/code&gt;: &lt;code&gt;/home&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;разбиение-диска&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;2&lt;/span&gt; Разбиение диска&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Установим тип разбиения в GPT.&lt;/li&gt;
&lt;li&gt;Разобьём на партиции:
&lt;ul&gt;
&lt;li&gt;p1 &amp;mdash; 500M, для &lt;code&gt;EFI&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;p2 &amp;mdash; 500&amp;ndash;1024M, для &lt;code&gt;/boot&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;p3 &amp;mdash; двойная оперативная память, для &lt;code&gt;swap&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;p4 &amp;mdash; всё остальное для &lt;code&gt;btrfs&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Создадим файловые системы:
&lt;ul&gt;
&lt;li&gt;p1 (&lt;code&gt;EFI&lt;/code&gt;):
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkfs.vfat -F32 -n EFI /dev/sda1
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;p2 (&lt;code&gt;/boot&lt;/code&gt;):
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkfs.ext4 -L boot /dev/sda2
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;p3 (&lt;code&gt;swap&lt;/code&gt;):
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkswap -L swap /dev/sda3
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;p4 (&lt;code&gt;btrfs&lt;/code&gt;)
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkfs.btrfs /dev/sda4
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;подготовка-раздела-с-btrfs&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;3&lt;/span&gt; Подготовка раздела с btrfs&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Подмонтируем раздел с btrfs:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkdir /mnt/gentoo
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Создадим подтома на btrfs:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/
btrfs subvol create @
btrfs subvol create @var
btrfs subvol create @var_tmp
btrfs subvol create @vm
btrfs subvol create @portage
btrfs subvol create @portage_local
btrfs subvol create @portage_com
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;копирование-существующих-файловых-систем&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;4&lt;/span&gt; Копирование существующих файловых систем&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Создадим точку монтирования:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkdir /mnt/from
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем root-партицию:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount /dev/vgs/root /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@
umount /mnt/from/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;/var&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount /dev/vgs/var /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@var
umount /mnt/from/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;portage&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount /dev/vgs/portage /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@portage
umount /mnt/from/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;portage_local&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount /dev/vgs/portage_local /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@portage_local
umount /mnt/from/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем и скопируем &lt;code&gt;/boot&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mkdir /mnt/to/
mount /dev/sda2 /mnt/to
mount /dev/sdb2 /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/to/
umount /mnt/to
umount /mnt/from
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;установка-загрузчика&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;5&lt;/span&gt; Установка загрузчика&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Перемонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;umount /mnt/gentoo
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@ /dev/sda4 /mnt/gentoo/
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@var /dev/sda4 /mnt/gentoo/var
mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@var_tmp /dev/sda4 /mnt/gentoo/var/tmp
mount /dev/sda2 /mnt/gentoo/boot/
mount /dev/sda1 /mnt/gentoo/boot/efi
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Подмонтируем псевдо-файловые системы:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount -o bind /dev /mnt/gentoo/dev/
mount -o bind /proc /mnt/gentoo/proc/
mount -o bind /sys /mnt/gentoo/sys/
mount -o bind /run /mnt/gentoo/run/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Установим загрузчик:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/
chroot /mnt/gentoo/ /bin/bash
grub-install /boot/
grub-mkconfig -o /boot/grub/grub.cfg
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;создадим-файл-монтирования-fstab&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;6&lt;/span&gt; Создадим файл монтирования fstab&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Узнаем идентификатор партиции с файловой системой btrfs:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;blkid /dev/sda4
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Получим строчку:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Создадим файл &lt;code&gt;/mnt/gentoo/etc/fstab&lt;/code&gt;
&lt;pre&gt;&lt;code class=&#34;language-conf-unix&#34;&gt;LABEL=&amp;quot;boot-m2&amp;quot;					/boot		ext4	relatime,discard					1 1
LABEL=&amp;quot;EFI-M2&amp;quot;					/boot/efi	vfat	defaults,discard					0 0
LABEL=&amp;quot;swap-m2&amp;quot;					none		swap	sw							0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/		btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/var		btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@var	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/var/tmp	btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/var/vm		btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@vm		0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/home		btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@home	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/usr/portage	btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@portage	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/usr/local/share/portage	btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_local	0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;	/com/lib/portage	btrfs	relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_com	0 0
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;копирование-специальных-файловых-систем&#34;&gt;&lt;span class=&#34;section-num&#34;&gt;7&lt;/span&gt; Копирование специальных файловых систем&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Для образов виртуальных машин следует отключить CoW (copy-on-write).&lt;/li&gt;
&lt;li&gt;Подмонтируем файловую систему &lt;code&gt;btrfs&lt;/code&gt;:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress=zstd:9,subvol=@vm /dev/sda4 /mnt/gentoo/var/vm
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Отключим для этого подтома CoW:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd /mnt/gentoo/var/
chattr +C vm
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Посмотреть результат можно командой:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;lsattr -a vm
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;Скопируем файлы:
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount /dev/vgs/vm /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/var/vm
umount /mnt/from/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
  </channel>
</rss>
