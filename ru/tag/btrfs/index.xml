<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>btrfs | Д. С. Кулябов</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link><atom:link href="https://yamadharma.github.io/ru/tag/btrfs/index.xml" rel="self" type="application/rss+xml"/><description>btrfs</description><generator>Wowchemy (https://wowchemy.com)</generator><language>ru-ru</language><copyright>© 2023 Dmitry S. Kulyabov</copyright><lastBuildDate>Sat, 28 May 2022 14:51:00 +0300</lastBuildDate><image><url>https://yamadharma.github.io/media/icon_hu0a661dd90139895e92e2f18ae9404407_611148_512x512_fill_lanczos_center_3.png</url><title>btrfs</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link></image><item><title>Дедупликация btrfs. Bees</title><link>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</link><pubDate>Sat, 28 May 2022 14:51:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</guid><description>&lt;p>BEES (Best-Effort Extent-Same) &amp;mdash; агент дедупликации &lt;em>btrfs&lt;/em>.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#плюсы-и-минусы">&lt;span class="section-num">2&lt;/span> Плюсы и минусы&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#сильные-стороны">&lt;span class="section-num">2.1&lt;/span> Сильные стороны&lt;/a>&lt;/li>
&lt;li>&lt;a href="#слабые-стороны">&lt;span class="section-num">2.2&lt;/span> Слабые стороны&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#установка">&lt;span class="section-num">3&lt;/span> Установка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#использование">&lt;span class="section-num">4&lt;/span> Использование&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#запуск">&lt;span class="section-num">4.1&lt;/span> Запуск&lt;/a>&lt;/li>
&lt;li>&lt;a href="#конфигурация">&lt;span class="section-num">4.2&lt;/span> Конфигурация&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>Репозиторий: &lt;a href="https://github.com/Zygo/bees" target="_blank" rel="noopener">https://github.com/Zygo/bees&lt;/a>&lt;/li>
&lt;li>Сайт: &lt;a href="https://zygo.github.io/bees/" target="_blank" rel="noopener">https://zygo.github.io/bees/&lt;/a>&lt;/li>
&lt;li>Уровень дедупликации: блочный.&lt;/li>
&lt;li>Работает как демон.&lt;/li>
&lt;li>Поддерживается инкрементное сканирование данных.&lt;/li>
&lt;/ul>
&lt;h2 id="плюсы-и-минусы">&lt;span class="section-num">2&lt;/span> Плюсы и минусы&lt;/h2>
&lt;h3 id="сильные-стороны">&lt;span class="section-num">2.1&lt;/span> Сильные стороны&lt;/h3>
&lt;ul>
&lt;li>Хеш-таблица с эффективным использованием места, можно использовать всего 1 ГБ хеш-таблицы на 10 ТБ уникальных данных.&lt;/li>
&lt;li>Демон постепенно выполняет дедупликацию новых данных, используя поиск по дереву btrfs.&lt;/li>
&lt;li>Поддержка сжатия btrfs, дедупликация комбинации сжатых и несжатых файлов.&lt;/li>
&lt;li>Постоянная хеш-таблица для быстрого перезапуска после выключения.&lt;/li>
&lt;li>Дедупликация всей файловой системы, включая моментальные снимки.&lt;/li>
&lt;li>Постоянный размер хеш-таблицы: использование оперативной памяти не увеличивается, если набор данных становится больше.&lt;/li>
&lt;li>Автоматическое саморегулирование в зависимости от загрузки системы.&lt;/li>
&lt;/ul>
&lt;h3 id="слабые-стороны">&lt;span class="section-num">2.2&lt;/span> Слабые стороны&lt;/h3>
&lt;ul>
&lt;li>Дедупликация только всей файловой системы.&lt;/li>
&lt;li>Требуются привилегии &lt;code>root&lt;/code> (или &lt;code>CAP_SYS_ADMIN&lt;/code>).&lt;/li>
&lt;li>Первый запуск может увеличить использование пространства метаданных, если существует много моментальных снимков.&lt;/li>
&lt;li>Постоянный размер хеш-таблицы: использование оперативной памяти не уменьшается, если набор данных становится меньше.&lt;/li>
&lt;li>Работает только с &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;/ul>
&lt;h2 id="установка">&lt;span class="section-num">3&lt;/span> Установка&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Gentoo:&lt;/p>
&lt;pre>&lt;code class="language-shell">emerge bees
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="использование">&lt;span class="section-num">4&lt;/span> Использование&lt;/h2>
&lt;h3 id="запуск">&lt;span class="section-num">4.1&lt;/span> Запуск&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>Для запуска используем скрипт &lt;code>beesd&lt;/code> (в исходниках &lt;code>scripts/beesd&lt;/code>).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Посмотрим идентификаторы &lt;code>UUID&lt;/code> файловых систем:&lt;/p>
&lt;pre>&lt;code class="language-shell">btrfs filesystem show
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>
&lt;p>Активируем демон дедупликации, указав &lt;code>UUID&lt;/code> в качестве идентификатора инстанса. Пусть &lt;code>UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code>, тогда команда активации будет иметь вид:&lt;/p>
&lt;pre>&lt;code class="language-shell">systemctl enable --now beesd@f8963df3-1320-4bc0-a125-62be185b029e
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="конфигурация">&lt;span class="section-num">4.2&lt;/span> Конфигурация&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>Для работы демона необходим файл конфигурации.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Шаблон для файла конфигурации:&lt;/p>
&lt;pre>&lt;code class="language-shell">/etc/bees/beesd.conf.sample
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>
&lt;p>Скопируйте его, задав произвольное имя (например, &lt;code>root.conf&lt;/code>):&lt;/p>
&lt;pre>&lt;code class="language-shell">cp /etc/bees/beesd.conf.sample /etc/bees/root.conf
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>
&lt;p>В этом файле задайте поле &lt;code>UUID&lt;/code> с необходимым значение.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Для запуска необходимо наличие файла с расширением &lt;code>.conf&lt;/code> и поля &lt;code>UUID&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Остальные поля конфигурации настраиваются по желанию. В противном случае используются значения по умолчанию.&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Дедупликация файловой системы btrfs</title><link>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</link><pubDate>Thu, 26 May 2022 14:29:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</guid><description>&lt;p>Дедупликация файловой системы btrfs.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#реализация">&lt;span class="section-num">2&lt;/span> Реализация&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#duperemove">&lt;span class="section-num">2.1&lt;/span> duperemove&lt;/a>&lt;/li>
&lt;li>&lt;a href="#bees">&lt;span class="section-num">2.2&lt;/span> bees&lt;/a>&lt;/li>
&lt;li>&lt;a href="#bedup">&lt;span class="section-num">2.3&lt;/span> bedup&lt;/a>&lt;/li>
&lt;li>&lt;a href="#btrfs-dedup">&lt;span class="section-num">2.4&lt;/span> btrfs-dedup&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#дедупликация-на-уровне-файлов">&lt;span class="section-num">3&lt;/span> Дедупликация на уровне файлов&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>При дедупликации идентифицируются блоки данных, которые имеют общие последовательности.&lt;/li>
&lt;li>Они объединяются в один экстент с семантикой копирования при записи.&lt;/li>
&lt;/ul>
&lt;h2 id="реализация">&lt;span class="section-num">2&lt;/span> Реализация&lt;/h2>
&lt;h3 id="duperemove">&lt;span class="section-num">2.1&lt;/span> duperemove&lt;/h3>
&lt;h3 id="bees">&lt;span class="section-num">2.2&lt;/span> bees&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/">Дедупликация btrfs. Bees&lt;/a>&lt;/li>
&lt;li>Уровень дедупликации: блочный.&lt;/li>
&lt;li>Работает как демон.&lt;/li>
&lt;li>Использую для дедупликации файловой системы.&lt;/li>
&lt;/ul>
&lt;h3 id="bedup">&lt;span class="section-num">2.3&lt;/span> bedup&lt;/h3>
&lt;h3 id="btrfs-dedup">&lt;span class="section-num">2.4&lt;/span> btrfs-dedup&lt;/h3>
&lt;h2 id="дедупликация-на-уровне-файлов">&lt;span class="section-num">3&lt;/span> Дедупликация на уровне файлов&lt;/h2>
&lt;ul>
&lt;li>Некоторые утилиты для дедупликации на уровне файлов поддерживают файловую систему &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;/ul></description></item><item><title>Обслуживание btrfs</title><link>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</link><pubDate>Thu, 23 Sep 2021 10:22:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</guid><description>&lt;p>Действия по обслуживанию Btrfs.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#скрипт-btrfsmaintenance">&lt;span class="section-num">1&lt;/span> Скрипт btrfsmaintenance&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1.1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#установка">&lt;span class="section-num">1.2&lt;/span> Установка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#запуск">&lt;span class="section-num">1.3&lt;/span> Запуск&lt;/a>&lt;/li>
&lt;li>&lt;a href="#удаление">&lt;span class="section-num">1.4&lt;/span> Удаление&lt;/a>&lt;/li>
&lt;li>&lt;a href="#фалы-конфигурации">&lt;span class="section-num">1.5&lt;/span> Фалы конфигурации&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="скрипт-btrfsmaintenance">&lt;span class="section-num">1&lt;/span> Скрипт btrfsmaintenance&lt;/h2>
&lt;h3 id="общая-информация">&lt;span class="section-num">1.1&lt;/span> Общая информация&lt;/h3>
&lt;ul>
&lt;li>Выполняемые действия:
&lt;ul>
&lt;li>периодическая проверка целостности;&lt;/li>
&lt;li>периодическая балансировка;&lt;/li>
&lt;li>периодический trim для SSD;&lt;/li>
&lt;li>периодическая дефрагментация.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Репозиторий: &lt;a href="https://github.com/kdave/btrfsmaintenance" target="_blank" rel="noopener">https://github.com/kdave/btrfsmaintenance&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="установка">&lt;span class="section-num">1.2&lt;/span> Установка&lt;/h3>
&lt;ul>
&lt;li>Gentoo Linux
&lt;pre>&lt;code class="language-shell">emerge sys-fs/btrfsmaintenance
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="запуск">&lt;span class="section-num">1.3&lt;/span> Запуск&lt;/h3>
&lt;ul>
&lt;li>Данные действия выполняют обычно менеджеры пакетов.&lt;/li>
&lt;li>Обновление таймеров через &lt;em>systemd&lt;/em>:
&lt;pre>&lt;code class="language-shell">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh systemd-timer
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Обновление таблиц &lt;em>crond&lt;/em> (без &lt;em>systemd&lt;/em>):
&lt;pre>&lt;code class="language-shell">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="удаление">&lt;span class="section-num">1.4&lt;/span> Удаление&lt;/h3>
&lt;ul>
&lt;li>Данные действия выполняют обычно менеджеры пакетов.&lt;/li>
&lt;li>Для удаления всех таймеров запустите:
&lt;pre>&lt;code class="language-shell">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh uninstall
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="фалы-конфигурации">&lt;span class="section-num">1.5&lt;/span> Фалы конфигурации&lt;/h3>
&lt;ul>
&lt;li>В зависимости от дистрибутива конфигурация может находиться в следующих файлах:
&lt;ul>
&lt;li>&lt;code>/etc/sysconfig/btrfsmaintenance&lt;/code>: RedHat, SUSE и производные;&lt;/li>
&lt;li>&lt;code>/etc/default/btrfsmaintenance&lt;/code>: Debian и производные, Gentoo.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>В качестве шаблона для этих файлов используется &lt;code>sysconfig.btrfsmaintenance&lt;/code>.&lt;/li>
&lt;/ul></description></item><item><title>Подтома btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</link><pubDate>Fri, 27 Aug 2021 11:41:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</guid><description>&lt;p>Подтома (subvolumes) btrfs.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#именование-подтомов">&lt;span class="section-num">1&lt;/span> Именование подтомов&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#список-подтомов">&lt;span class="section-num">1.1&lt;/span> Список подтомов&lt;/a>&lt;/li>
&lt;li>&lt;a href="#минимально-рекомендуемый-набор-подтомов">&lt;span class="section-num">1.2&lt;/span> Минимально рекомендуемый набор подтомов&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#создание-подтомов">&lt;span class="section-num">2&lt;/span> Создание подтомов&lt;/a>&lt;/li>
&lt;li>&lt;a href="#отключение-cow">&lt;span class="section-num">3&lt;/span> Отключение CoW&lt;/a>&lt;/li>
&lt;li>&lt;a href="#монтирование-подтомов-в-fstab">&lt;span class="section-num">4&lt;/span> Монтирование подтомов в fstab&lt;/a>&lt;/li>
&lt;li>&lt;a href="#создание-нового-подтома">&lt;span class="section-num">5&lt;/span> Создание нового подтома&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="именование-подтомов">&lt;span class="section-num">1&lt;/span> Именование подтомов&lt;/h2>
&lt;ul>
&lt;li>Для определённости я называю подтома по шаблону &lt;code>@имя_подтома&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h3 id="список-подтомов">&lt;span class="section-num">1.1&lt;/span> Список подтомов&lt;/h3>
&lt;div class="table-caption">
&lt;span class="table-number">&amp;#1058;&amp;#1072;&amp;#1073;&amp;#1083;&amp;#1080;&amp;#1094;&amp;#1072; 1:&lt;/span>
Возможные наименования подтомов btrfs
&lt;/div>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Подтом&lt;/th>
&lt;th>Точка монтирования&lt;/th>
&lt;th>Описание&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>@&lt;/code>&lt;/td>
&lt;td>&lt;code>/&lt;/code>&lt;/td>
&lt;td>Корневой каталог (системные файлы)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@home&lt;/code>&lt;/td>
&lt;td>&lt;code>/home&lt;/code>&lt;/td>
&lt;td>Домашний каталог с пользовательскими данными&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots&lt;/code>&lt;/td>
&lt;td>‒&lt;/td>
&lt;td>Корневой подтом для снапшотов&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots/root&lt;/code>&lt;/td>
&lt;td>&lt;code>/.snapshots&lt;/code>&lt;/td>
&lt;td>Содержит снапшоты корня, которые создает &lt;code>snapper&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots/home&lt;/code>&lt;/td>
&lt;td>&lt;code>/home/.snapshots&lt;/code>&lt;/td>
&lt;td>Содержит снапшоты домашнего каталога, которые создает &lt;code>snapper&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@machines&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/machines&lt;/code>&lt;/td>
&lt;td>Если не существует, то создаст systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@portables&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/portables&lt;/code>&lt;/td>
&lt;td>Если не существует, то создаст systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@docker&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/docker&lt;/code>&lt;/td>
&lt;td>Докер создаёт подтома в &lt;code>./btrfs/subvolumes&lt;/code> либо в &lt;code>./XXX/btrfs/subvolumes&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var&lt;/code>&lt;/td>
&lt;td>&lt;code>/var&lt;/code>&lt;/td>
&lt;td>Аналогично выше описанному&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var_lib&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib&lt;/code>&lt;/td>
&lt;td>Вместо создания &lt;code>@machines&lt;/code>, &lt;code>@portables&lt;/code>, &lt;code>@docker&lt;/code> можно создать только этот, если в &lt;code>/var/lib&lt;/code> не будет храниться чего-то важного&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var_tmp&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/tmp&lt;/code>&lt;/td>
&lt;td>Содержит временные файлы. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var_log&lt;/code> или &lt;code>@log&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/log&lt;/code>&lt;/td>
&lt;td>Содержит большое количество файлов, которые пишутся маленькими частями. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@swap&lt;/code>&lt;/td>
&lt;td>&lt;code>/swap&lt;/code> или &lt;code>/var/swap&lt;/code>, или &lt;code>/var/lib/swap&lt;/code>&lt;/td>
&lt;td>Подтом для файла подкачки. Должен монтироваться с &lt;code>nodatacow&lt;/code> (см. &lt;a href="https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/">Файл подкачки на btrfs&lt;/a>)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@libvirt&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/libvirt/images&lt;/code>&lt;/td>
&lt;td>Образы для &lt;em>libvirt&lt;/em>. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="минимально-рекомендуемый-набор-подтомов">&lt;span class="section-num">1.2&lt;/span> Минимально рекомендуемый набор подтомов&lt;/h3>
&lt;ul>
&lt;li>Минимум нужны два подтома: &lt;code>@&lt;/code> и &lt;code>@home&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h2 id="создание-подтомов">&lt;span class="section-num">2&lt;/span> Создание подтомов&lt;/h2>
&lt;ul>
&lt;li>При установки системы я создаю подтома следующим образом:
&lt;ul>
&lt;li>Подмонтируем раздел с btrfs:
&lt;pre>&lt;code class="language-shell">mkdir /mnt/gentoo
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Создадим подтома на btrfs:
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/
btrfs subvol create @
btrfs subvol create @var
btrfs subvol create @var_tmp
btrfs subvol create @var_log
btrfs subvol create @vm
btrfs subvol create @portage
btrfs subvol create @portage_local
btrfs subvol create @portage_com
btrfs subvol create @libvirt
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="отключение-cow">&lt;span class="section-num">3&lt;/span> Отключение CoW&lt;/h2>
&lt;ul>
&lt;li>Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write).&lt;/li>
&lt;li>Так же стоит отключить &lt;em>CoW&lt;/em> для часто изменяемых файлов (например, журналов).&lt;/li>
&lt;li>Подмонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@vm /dev/sda4 /mnt/gentoo/var/vm
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@libvirt /dev/sda4 /mnt/gentoo/var/lib/libvirt/images
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@var_log /dev/sda4 /mnt/gentoo/var/log
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp /dev/sda4 /mnt/gentoo/var/tmp
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Отключим для этого подтома CoW:
&lt;ul>
&lt;li>Для &lt;code>/var/vm&lt;/code>
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/var/
chattr +C vm
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Для &lt;code>/var/lib/libvirt/images&lt;/code>
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/var/lib/libvirt/
chattr +C images
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Для &lt;code>/var/log&lt;/code>
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/var/
chattr +C log
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Для &lt;code>/var/tmp&lt;/code>
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/var/
chattr +C tmp
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Посмотреть результат можно командой:
&lt;pre>&lt;code class="language-shell">lsattr -a /mnt/gentoo/var/
lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="монтирование-подтомов-в-fstab">&lt;span class="section-num">4&lt;/span> Монтирование подтомов в fstab&lt;/h2>
&lt;ul>
&lt;li>При монтировании я указываю универсальный идентификатор (UUID) файловой системы:
&lt;pre>&lt;code class="language-conf-unix"># /etc/fstab
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; / btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@ 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /var btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@var 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /var/tmp btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /var/vm btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@vm 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /home btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@home 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /usr/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /usr/local/share/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_local 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /com/lib/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_com 0 0
UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /var/lib/libvirt/images btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@libvirt 0 0
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Идентификатор файловой системы можно узнать следующим образом:
&lt;pre>&lt;code class="language-shell">blkid /dev/sda4
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="создание-нового-подтома">&lt;span class="section-num">5&lt;/span> Создание нового подтома&lt;/h2>
&lt;ul>
&lt;li>После установки системы может возникнуть необходимость создания дополнительных подтомов на существующем томе.
&lt;pre>&lt;code class="language-shell">mkdir /mnt/btrfs
mount UUID=f8963df3-1320-4bc0-a125-62be185b029e /mnt/btrfs
btrfs subvolume create /mnt/btrfs/@data
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подключим в &lt;code>/etc/fstab&lt;/code>:
&lt;pre>&lt;code class="language-shell">UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot; /data btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@data 0 0
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul></description></item><item><title>Файловая система btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</link><pubDate>Fri, 27 Aug 2021 11:33:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</guid><description>&lt;p>Файловая система &lt;em>Btrfs&lt;/em>.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#свойства">&lt;span class="section-num">1.1&lt;/span> Свойства&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#разное">&lt;span class="section-num">2&lt;/span> Разное&lt;/a>&lt;/li>
&lt;li>&lt;a href="#необходимое-программное-обеспечение">&lt;span class="section-num">3&lt;/span> Необходимое программное обеспечение&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#btrfs-progs">&lt;span class="section-num">3.1&lt;/span> btrfs-progs&lt;/a>&lt;/li>
&lt;li>&lt;a href="#btrfsmaintenance">&lt;span class="section-num">3.2&lt;/span> btrfsmaintenance&lt;/a>&lt;/li>
&lt;li>&lt;a href="#snapper">&lt;span class="section-num">3.3&lt;/span> snapper&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;h3 id="свойства">&lt;span class="section-num">1.1&lt;/span> Свойства&lt;/h3>
&lt;ul>
&lt;li>Копирование при записи (copy on write &amp;mdash; CoW).
&lt;ul>
&lt;li>Все копии файла суммарно занимают на диске столько же места сколько оригинал, а при изменениях файлов данные всегда пишутся в новые страницы.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Снапшоты.
&lt;ul>
&lt;li>Можно делать снимки состояния подтома на лету, а потом вернуть это состояние, например, после неудачного обновления или удаления чего-то нужного, просто отредактировав &lt;code>/etc/fstab&lt;/code> и выполнив &lt;code>mount -o remount mountpoint&lt;/code>.&lt;/li>
&lt;li>Для автоматического создания снапшотов можно использовать утилиту &lt;code>snapper&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Поддержка сжатия.&lt;/li>
&lt;li>Поддержка подтомов.
&lt;ul>
&lt;li>Вместо разделов предпочтительно использовать подтома.&lt;/li>
&lt;li>Подтома имеют динамический размер.&lt;/li>
&lt;li>Снапшоты являются по сути подтомами.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Поддержка дисков SSD.&lt;/li>
&lt;/ul>
&lt;h2 id="разное">&lt;span class="section-num">2&lt;/span> Разное&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/">Перенос Linux на btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/">Подтома btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/">Обслуживание btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/">Дедупликация файловой системы btrfs&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="необходимое-программное-обеспечение">&lt;span class="section-num">3&lt;/span> Необходимое программное обеспечение&lt;/h2>
&lt;h3 id="btrfs-progs">&lt;span class="section-num">3.1&lt;/span> btrfs-progs&lt;/h3>
&lt;ul>
&lt;li>Утилиты для работы с &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;pre>&lt;code class="language-shell">emerge sys-fs/btrfs-progs
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="btrfsmaintenance">&lt;span class="section-num">3.2&lt;/span> btrfsmaintenance&lt;/h3>
&lt;ul>
&lt;li>Скрипт для регулярного обслуживания файловой системы &lt;em>btrfs&lt;/em>&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;pre>&lt;code class="language-shell">emerge sys-fs/btrfsmaintenance
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="snapper">&lt;span class="section-num">3.3&lt;/span> snapper&lt;/h3>
&lt;ul>
&lt;li>Управление снапшотами&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;pre>&lt;code class="language-shell">emerge app-backup/snapper
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Перенос Linux на btrfs</title><link>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</link><pubDate>Fri, 21 May 2021 20:38:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</guid><description>&lt;p>Перенос Gentoo Linux с одного диска на другой. На новом диске делается система btrfs.&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">Содержание&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#исходное-состояние-системы">&lt;span class="section-num">1&lt;/span> Исходное состояние системы&lt;/a>&lt;/li>
&lt;li>&lt;a href="#разбиение-диска">&lt;span class="section-num">2&lt;/span> Разбиение диска&lt;/a>&lt;/li>
&lt;li>&lt;a href="#подготовка-раздела-с-btrfs">&lt;span class="section-num">3&lt;/span> Подготовка раздела с btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="#копирование-существующих-файловых-систем">&lt;span class="section-num">4&lt;/span> Копирование существующих файловых систем&lt;/a>&lt;/li>
&lt;li>&lt;a href="#установка-загрузчика">&lt;span class="section-num">5&lt;/span> Установка загрузчика&lt;/a>&lt;/li>
&lt;li>&lt;a href="#создадим-файл-монтирования-fstab">&lt;span class="section-num">6&lt;/span> Создадим файл монтирования fstab&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#копирование-специальных-файловых-систем">&lt;span class="section-num">6.1&lt;/span> Копирование специальных файловых систем&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#файл-подкачки-на-файловой-системе-btrfs">&lt;span class="section-num">7&lt;/span> Файл подкачки на файловой системе btrfs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="исходное-состояние-системы">&lt;span class="section-num">1&lt;/span> Исходное состояние системы&lt;/h2>
&lt;ul>
&lt;li>Исходно система установлена на LVM:
&lt;ul>
&lt;li>&lt;code>/dev/sdb1&lt;/code>: &lt;code>/boot/EFI&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/sdb2&lt;/code>: &lt;code>/boot&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/root&lt;/code>: &lt;code>/&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/var&lt;/code>: &lt;code>/var&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/var_tmp&lt;/code>: &lt;code>/var/tmp&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/vm&lt;/code>: &lt;code>/var/vm&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage&lt;/code>: &lt;code>/usr/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage_local&lt;/code>: &lt;code>/usr/local/share/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage_com&lt;/code>: &lt;code>/com/lib/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/home&lt;/code>: &lt;code>/home&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="разбиение-диска">&lt;span class="section-num">2&lt;/span> Разбиение диска&lt;/h2>
&lt;ul>
&lt;li>Установим тип разбиения в GPT.&lt;/li>
&lt;li>Разобьём на партиции:
&lt;ul>
&lt;li>p1 &amp;mdash; 500M, для &lt;code>EFI&lt;/code>.&lt;/li>
&lt;li>p2 &amp;mdash; 500&amp;ndash;1024M, для &lt;code>/boot&lt;/code>.&lt;/li>
&lt;li>p3 &amp;mdash; двойная оперативная память, для &lt;code>swap&lt;/code>.
&lt;ul>
&lt;li>Также можно разместить файл подкачки на &lt;code>btrfs&lt;/code> (см. &lt;a href="https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/">Файл подкачки на btrfs&lt;/a>).&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>p4 &amp;mdash; всё остальное для &lt;code>btrfs&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Создадим файловые системы:
&lt;ul>
&lt;li>p1 (&lt;code>EFI&lt;/code>):
&lt;pre>&lt;code class="language-shell">mkfs.vfat -F32 -n EFI /dev/sda1
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>p2 (&lt;code>/boot&lt;/code>):
&lt;pre>&lt;code class="language-shell">mkfs.ext4 -L boot /dev/sda2
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>p3 (&lt;code>swap&lt;/code> в случае отдельной партиции):
&lt;pre>&lt;code class="language-shell">mkswap -L swap /dev/sda3
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>p4 (&lt;code>btrfs&lt;/code>)
&lt;pre>&lt;code class="language-shell">mkfs.btrfs /dev/sda4
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="подготовка-раздела-с-btrfs">&lt;span class="section-num">3&lt;/span> Подготовка раздела с btrfs&lt;/h2>
&lt;ul>
&lt;li>Подмонтируем раздел с btrfs:
&lt;pre>&lt;code class="language-shell">mkdir /mnt/gentoo
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Создадим подтома на btrfs (см. &lt;a href="https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/">Подтома btrfs&lt;/a>):
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/
btrfs subvol create @
btrfs subvol create @var
btrfs subvol create @var_tmp
btrfs subvol create @var_log
btrfs subvol create @vm
btrfs subvol create @home
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>И подтома специально для &lt;em>Gentoo Linux&lt;/em>:
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/
btrfs subvol create @portage
btrfs subvol create @portage_local
btrfs subvol create @portage_com
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Если используется файл подкачки на файловой системе, то создадим для него подтом:
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/
btrfs subvol create @swap
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="копирование-существующих-файловых-систем">&lt;span class="section-num">4&lt;/span> Копирование существующих файловых систем&lt;/h2>
&lt;ul>
&lt;li>Создадим точку монтирования:
&lt;pre>&lt;code class="language-shell">mkdir /mnt/from
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем и скопируем root-партицию:
&lt;pre>&lt;code class="language-shell">mount /dev/vgs/root /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@
umount /mnt/from/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>/var&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount /dev/vgs/var /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@var
umount /mnt/from/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>portage&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount /dev/vgs/portage /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@portage
umount /mnt/from/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>portage_local&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount /dev/vgs/portage_local /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/@portage_local
umount /mnt/from/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>/boot&lt;/code>:
&lt;pre>&lt;code class="language-shell">mkdir /mnt/to/
mount /dev/sda2 /mnt/to
mount /dev/sdb2 /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/to/
umount /mnt/to
umount /mnt/from
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="установка-загрузчика">&lt;span class="section-num">5&lt;/span> Установка загрузчика&lt;/h2>
&lt;ul>
&lt;li>Перемонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;pre>&lt;code class="language-shell">umount /mnt/gentoo
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@ /dev/sda4 /mnt/gentoo/
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@var /dev/sda4 /mnt/gentoo/var
mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp /dev/sda4 /mnt/gentoo/var/tmp
mount /dev/sda2 /mnt/gentoo/boot/
mount /dev/sda1 /mnt/gentoo/boot/efi
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем псевдо-файловые системы:
&lt;pre>&lt;code class="language-shell">mount -o bind /dev /mnt/gentoo/dev/
mount -o bind /proc /mnt/gentoo/proc/
mount -o bind /sys /mnt/gentoo/sys/
mount -o bind /run /mnt/gentoo/run/
mount -t efivarfs efivarfs /mnt/gentoo/sys/firmware/efi/efivars
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Установим загрузчик:
&lt;pre>&lt;code class="language-shell">cd /mnt/gentoo/
chroot /mnt/gentoo/ /bin/bash
grub-install /boot/
grub-mkconfig -o /boot/grub/grub.cfg
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="создадим-файл-монтирования-fstab">&lt;span class="section-num">6&lt;/span> Создадим файл монтирования fstab&lt;/h2>
&lt;ul>
&lt;li>Узнаем идентификатор партиции с файловой системой btrfs:
&lt;pre>&lt;code class="language-shell">blkid /dev/sda4
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Получим строчку:
&lt;pre>&lt;code class="language-shell">UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot;
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Создадим файл &lt;code>/mnt/gentoo/etc/fstab&lt;/code>:
&lt;pre>&lt;code class="language-conf-unix">LABEL=&amp;quot;boot&amp;quot; /boot ext4 relatime,discard 1 1
LABEL=&amp;quot;EFI&amp;quot; /boot/efi vfat defaults,discard,flush,tz=UTC 0 0
LABEL=&amp;quot;swap&amp;quot; none swap sw 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; / btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@ 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /var btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@var 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /var/tmp btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@var_tmp 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /var/vm btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@vm 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /home btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@home 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /usr/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /usr/local/share/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_local 0 0
UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /com/lib/portage btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@portage_com 0 0
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Если используется файл подкачки, то вместо отдельной партиции следует подключить этот файл в &lt;code>/mnt/gentoo/etc/fstab&lt;/code>:
&lt;pre>&lt;code class="language-conf-unix">UUID=&amp;quot;&amp;lt;uuid_number&amp;gt;&amp;quot; /swap btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@swap 0 0
/swap/swapfile none swap sw 0 0
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h3 id="копирование-специальных-файловых-систем">&lt;span class="section-num">6.1&lt;/span> Копирование специальных файловых систем&lt;/h3>
&lt;ul>
&lt;li>Файловые системы с отключённым CoW (copy-on-write) копируются после монтирования каталога.&lt;/li>
&lt;li>Скопируем файлы:
&lt;pre>&lt;code class="language-shell">mount /dev/vgs/vm /mnt/from/
rsync -av -HS --delete /mnt/from/ /mnt/gentoo/var/vm
umount /mnt/from/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;h2 id="файл-подкачки-на-файловой-системе-btrfs">&lt;span class="section-num">7&lt;/span> Файл подкачки на файловой системе btrfs&lt;/h2>
&lt;ul>
&lt;li>Для раздела файла подкачки следует отключить CoW (copy-on-write).&lt;/li>
&lt;li>Подмонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount -tbtrfs -orelatime,discard,autodefrag,compress=zstd:9,subvol=@ /dev/sda4 /mnt/gentoo/
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Создадим точку монтирования:
&lt;pre>&lt;code class="language-shell">mkdir /mnt/gentoo/swap
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Подмонтируем подтом &lt;code>@swap&lt;/code>:
&lt;pre>&lt;code class="language-shell">mount -o subvol=@swap /dev/sda4 /mnt/gentoo/swap
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Отключим для этого подтома CoW:
&lt;pre>&lt;code class="language-shell">chattr +C /mnt/gentoo/swap
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Создадим файл подкачки:
&lt;pre>&lt;code class="language-shell">truncate -s 0 /mnt/gentoo/swap/swapfile
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Установим права доступа &lt;code>600&lt;/code> к файлу подкачки:
&lt;pre>&lt;code class="language-shell">chmod 600 /mnt/gentoo/swap/swapfile
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Установим размер файла подкачки исходя из размера оперативной памяти:
&lt;pre>&lt;code class="language-shell">fallocate -l $(free -h --si | awk 'NR == 2 {print $2}') /mnt/gentoo/swap/swapfile
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Отформатируем файл подкачки:
&lt;pre>&lt;code class="language-shell">mkswap /mnt/gentoo/swap/swapfile
&lt;/code>&lt;/pre>
&lt;/li>
&lt;li>Активируем файл подкачки:
&lt;pre>&lt;code class="language-shell">swapon /mnt/gentoo/swap/swapfile
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul></description></item></channel></rss>