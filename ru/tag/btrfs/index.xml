<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Btrfs | Д. С. Кулябов</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link><atom:link href="https://yamadharma.github.io/ru/tag/btrfs/index.xml" rel="self" type="application/rss+xml"/><description>Btrfs</description><generator>Hugo Blox Builder (https://hugoblox.com)</generator><language>ru-ru</language><copyright>© 2025 Dmitry S. Kulyabov</copyright><lastBuildDate>Fri, 23 Feb 2024 18:08:00 +0300</lastBuildDate><image><url>https://yamadharma.github.io/media/icon_hu15752663207405015554.png</url><title>Btrfs</title><link>https://yamadharma.github.io/ru/tag/btrfs/</link></image><item><title>Дедупликация файлов. jdupes</title><link>https://yamadharma.github.io/ru/post/2024/02/23/file-deduplication-jdupes/</link><pubDate>Fri, 23 Feb 2024 18:08:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2024/02/23/file-deduplication-jdupes/</guid><description>&lt;p>Дедупликация файлов. jdupes.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#примеры">&lt;span class="section-num">2&lt;/span> Примеры&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>Сайт: &lt;a href="https://www.jdupes.com/" target="_blank" rel="noopener">https://www.jdupes.com/&lt;/a>&lt;/li>
&lt;li>Репозиторий:
&lt;ul>
&lt;li>&lt;a href="https://codeberg.org/jbruchon/jdupes" target="_blank" rel="noopener">https://codeberg.org/jbruchon/jdupes&lt;/a>&lt;/li>
&lt;li>&lt;del>&lt;a href="https://github.com/jbruchon/jdupes" target="_blank" rel="noopener">https://github.com/jbruchon/jdupes&lt;/a>&lt;/del>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Форк &lt;code>fdupes&lt;/code>.&lt;/li>
&lt;li>Включает поддержку дедупликации BTRFS.&lt;/li>
&lt;/ul>
&lt;h2 id="примеры">&lt;span class="section-num">2&lt;/span> Примеры&lt;/h2>
&lt;ul>
&lt;li>Команда применяется к списку каталогов.&lt;/li>
&lt;li>Найти дубликаты файлов:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">jdupes --recurse --print-summarize dir1 dir2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Преобразовать дубликаты в жёсткие ссылки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">jdupes --recurse --link-hard dir1 dir2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul></description></item><item><title>btrfs. Контрольные суммы</title><link>https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/</link><pubDate>Mon, 19 Feb 2024 15:44:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/</guid><description>&lt;p>Контрольные суммы btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#виды-контрольных-сумм">&lt;span class="section-num">2&lt;/span> Виды контрольных сумм&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>Контрольная сумма вычисляется для данных и метаданных (по умолчанию).&lt;/li>
&lt;li>Контрольная сумма вычисляется перед записью и проверяется после чтения блоков с устройств.&lt;/li>
&lt;li>Контрольная сумма всего блока метаданных хранится в заголовке узла b-дерева.&lt;/li>
&lt;li>У каждого блока данных есть отдельная контрольная сумма, хранящаяся в дереве контрольных сумм.&lt;/li>
&lt;/ul>
&lt;h2 id="виды-контрольных-сумм">&lt;span class="section-num">2&lt;/span> Виды контрольных сумм&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>CRC32C&lt;/p>
&lt;ul>
&lt;li>32-битный дайджест;&lt;/li>
&lt;li>используется по умолчанию;&lt;/li>
&lt;li>лучшая обратная совместимость;&lt;/li>
&lt;li>очень быстро вычисляется;&lt;/li>
&lt;li>современные процессоры имеют поддержку на уровне инструкций;&lt;/li>
&lt;li>не устойчивы к коллизиям;&lt;/li>
&lt;li>достаточно хорошие возможности обнаружения ошибок.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>XXHASH&lt;/p>
&lt;ul>
&lt;li>64-битный дайджест;&lt;/li>
&lt;li>может использоваться в качестве преемника CRC32C;&lt;/li>
&lt;li>очень быстро вычисляется;&lt;/li>
&lt;li>оптимизирована для современных процессоров, использующих конвейерную обработку инструкций;&lt;/li>
&lt;li>хорошая устойчивость к коллизиям;&lt;/li>
&lt;li>хорошее обнаружение ошибок.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>SHA256&lt;/p>
&lt;ul>
&lt;li>256-битный дайджест;&lt;/li>
&lt;li>хэш криптографической стойкости;&lt;/li>
&lt;li>относительно медленный, но с возможным ускорением инструкций ЦП или специализированными аппаратными картами;&lt;/li>
&lt;li>сертифицированный FIPS;&lt;/li>
&lt;li>широко используется.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>BLAKE2b&lt;/p>
&lt;ul>
&lt;li>256-битный дайджест;&lt;/li>
&lt;li>хеш криптографической стойкости;&lt;/li>
&lt;li>быстрее SHA256;&lt;/li>
&lt;li>возможно ускорение с использованием расширений SIMD;&lt;/li>
&lt;li>не стандартизировано;&lt;/li>
&lt;li>широко используется;&lt;/li>
&lt;li>алгоритм BLAKE2b-256 оптимизирован для 64-битных платформ.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Восстановление btrfs</title><link>https://yamadharma.github.io/ru/post/2023/07/21/btrfs-recovery/</link><pubDate>Fri, 21 Jul 2023 16:56:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2023/07/21/btrfs-recovery/</guid><description>&lt;p>Восстановление btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#предварительная-подготовка">&lt;span class="section-num">1&lt;/span> Предварительная подготовка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#восстановление">&lt;span class="section-num">2&lt;/span> Восстановление&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="предварительная-подготовка">&lt;span class="section-num">1&lt;/span> Предварительная подготовка&lt;/h2>
&lt;ul>
&lt;li>Подготовьте флеш-диск (см. &lt;a href="https://yamadharma.github.io/ru/post/2021/04/10/bootable-usb-stick/">Загрузочная флешка&lt;/a>)&lt;/li>
&lt;li>Поместите на него образ SystemRescueCD (&lt;a href="https://www.system-rescue.org/" target="_blank" rel="noopener">https://www.system-rescue.org/&lt;/a>).&lt;/li>
&lt;/ul>
&lt;h2 id="восстановление">&lt;span class="section-num">2&lt;/span> Восстановление&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Загружаемся с внешнего устройства.&lt;/p>
&lt;ul>
&lt;li>При загрузке с SystemRescueCD лучше выбрать пункт &lt;code>copy system to RAM&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Запускаем проверку блоков:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/sda1 /mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs scrub start -Bd /mnt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Если система на монтируется, проверяем блоки на устройстве:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs scrub start -Bd /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Если не монтируется, попробуйте смонтировать для чтения:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -o rescue /dev/sda1 /mnt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Запустите проверку файловой системы:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs check /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Если не поможет, скопируйте файловую систему:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs restore /dev/sda1 /mnt/usbdrive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Попробуйте восстановить суперблок:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs rescue super-recover /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Попробуйте удалить лог:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs rescue zero-log /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Попробуйте восстановить чанки:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs rescue chunk-recover /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Попробуйте смонтировать устройство. Если смонтируется нормально, завершайте.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Запускаем восстановление файловой системы на устройстве (это может быть опасно):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs check --repair /dev/sda1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Запускаем проверку блоков:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/sda1 /mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs scrub start -Bd /mnt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul></description></item><item><title>Дедупликация btrfs. Bees</title><link>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</link><pubDate>Sat, 28 May 2022 14:51:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/</guid><description>&lt;p>BEES (Best-Effort Extent-Same) &amp;mdash; агент дедупликации &lt;em>btrfs&lt;/em>.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#плюсы-и-минусы">&lt;span class="section-num">2&lt;/span> Плюсы и минусы&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#сильные-стороны">&lt;span class="section-num">2.1&lt;/span> Сильные стороны&lt;/a>&lt;/li>
&lt;li>&lt;a href="#слабые-стороны">&lt;span class="section-num">2.2&lt;/span> Слабые стороны&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#установка">&lt;span class="section-num">3&lt;/span> Установка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#использование">&lt;span class="section-num">4&lt;/span> Использование&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#запуск">&lt;span class="section-num">4.1&lt;/span> Запуск&lt;/a>&lt;/li>
&lt;li>&lt;a href="#конфигурация">&lt;span class="section-num">4.2&lt;/span> Конфигурация&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>Репозиторий: &lt;a href="https://github.com/Zygo/bees" target="_blank" rel="noopener">https://github.com/Zygo/bees&lt;/a>&lt;/li>
&lt;li>Сайт: &lt;a href="https://zygo.github.io/bees/" target="_blank" rel="noopener">https://zygo.github.io/bees/&lt;/a>&lt;/li>
&lt;li>Уровень дедупликации: блочный.&lt;/li>
&lt;li>Работает как демон.&lt;/li>
&lt;li>Поддерживается инкрементное сканирование данных.&lt;/li>
&lt;/ul>
&lt;h2 id="плюсы-и-минусы">&lt;span class="section-num">2&lt;/span> Плюсы и минусы&lt;/h2>
&lt;h3 id="сильные-стороны">&lt;span class="section-num">2.1&lt;/span> Сильные стороны&lt;/h3>
&lt;ul>
&lt;li>Хеш-таблица с эффективным использованием места, можно использовать всего 1 ГБ хеш-таблицы на 10 ТБ уникальных данных.&lt;/li>
&lt;li>Демон постепенно выполняет дедупликацию новых данных, используя поиск по дереву btrfs.&lt;/li>
&lt;li>Поддержка сжатия btrfs, дедупликация комбинации сжатых и несжатых файлов.&lt;/li>
&lt;li>Постоянная хеш-таблица для быстрого перезапуска после выключения.&lt;/li>
&lt;li>Дедупликация всей файловой системы, включая моментальные снимки.&lt;/li>
&lt;li>Постоянный размер хеш-таблицы: использование оперативной памяти не увеличивается, если набор данных становится больше.&lt;/li>
&lt;li>Автоматическое саморегулирование в зависимости от загрузки системы.&lt;/li>
&lt;/ul>
&lt;h3 id="слабые-стороны">&lt;span class="section-num">2.2&lt;/span> Слабые стороны&lt;/h3>
&lt;ul>
&lt;li>Дедупликация только всей файловой системы.&lt;/li>
&lt;li>Требуются привилегии &lt;code>root&lt;/code> (или &lt;code>CAP_SYS_ADMIN&lt;/code>).&lt;/li>
&lt;li>Первый запуск может увеличить использование пространства метаданных, если существует много моментальных снимков.&lt;/li>
&lt;li>Постоянный размер хеш-таблицы: использование оперативной памяти не уменьшается, если набор данных становится меньше.&lt;/li>
&lt;li>Работает только с &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;/ul>
&lt;h2 id="установка">&lt;span class="section-num">3&lt;/span> Установка&lt;/h2>
&lt;ul>
&lt;li>Gentoo:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">emerge bees
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="использование">&lt;span class="section-num">4&lt;/span> Использование&lt;/h2>
&lt;h3 id="запуск">&lt;span class="section-num">4.1&lt;/span> Запуск&lt;/h3>
&lt;ul>
&lt;li>Для запуска используем скрипт &lt;code>beesd&lt;/code> (в исходниках &lt;code>scripts/beesd&lt;/code>).&lt;/li>
&lt;li>Посмотрим идентификаторы &lt;code>UUID&lt;/code> файловых систем:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs filesystem show
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Активируем демон дедупликации, указав &lt;code>UUID&lt;/code> в качестве идентификатора инстанса. Пусть &lt;code>UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code>, тогда команда активации будет иметь вид:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> --now beesd@f8963df3-1320-4bc0-a125-62be185b029e
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="конфигурация">&lt;span class="section-num">4.2&lt;/span> Конфигурация&lt;/h3>
&lt;ul>
&lt;li>Для работы демона необходим файл конфигурации.&lt;/li>
&lt;li>Шаблон для файла конфигурации:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/bees/beesd.conf.sample
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Скопируйте его, задав произвольное имя (например, &lt;code>root.conf&lt;/code>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cp /etc/bees/beesd.conf.sample /etc/bees/root.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>В этом файле задайте поле &lt;code>UUID&lt;/code> с необходимым значение.&lt;/li>
&lt;li>Для запуска необходимо наличие файла с расширением &lt;code>.conf&lt;/code> и поля &lt;code>UUID&lt;/code>.&lt;/li>
&lt;li>Остальные поля конфигурации настраиваются по желанию. В противном случае используются значения по умолчанию.&lt;/li>
&lt;/ul></description></item><item><title>Дедупликация файловой системы btrfs</title><link>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</link><pubDate>Thu, 26 May 2022 14:29:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/</guid><description>&lt;p>Дедупликация файловой системы btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#реализация">&lt;span class="section-num">2&lt;/span> Реализация&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#duperemove">&lt;span class="section-num">2.1&lt;/span> duperemove&lt;/a>&lt;/li>
&lt;li>&lt;a href="#bees">&lt;span class="section-num">2.2&lt;/span> bees&lt;/a>&lt;/li>
&lt;li>&lt;a href="#bedup">&lt;span class="section-num">2.3&lt;/span> bedup&lt;/a>&lt;/li>
&lt;li>&lt;a href="#btrfs-dedup">&lt;span class="section-num">2.4&lt;/span> btrfs-dedup&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#дедупликация-на-уровне-файлов">&lt;span class="section-num">3&lt;/span> Дедупликация на уровне файлов&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>При дедупликации идентифицируются блоки данных, которые имеют общие последовательности.&lt;/li>
&lt;li>Они объединяются в один экстент с семантикой копирования при записи.&lt;/li>
&lt;/ul>
&lt;h2 id="реализация">&lt;span class="section-num">2&lt;/span> Реализация&lt;/h2>
&lt;h3 id="duperemove">&lt;span class="section-num">2.1&lt;/span> duperemove&lt;/h3>
&lt;h3 id="bees">&lt;span class="section-num">2.2&lt;/span> bees&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2022/05/28/deduplication-btrfs-filesystem-bees/">Дедупликация btrfs. Bees&lt;/a>&lt;/li>
&lt;li>Уровень дедупликации: блочный.&lt;/li>
&lt;li>Работает как демон.&lt;/li>
&lt;li>Использую для дедупликации файловой системы.&lt;/li>
&lt;/ul>
&lt;h3 id="bedup">&lt;span class="section-num">2.3&lt;/span> bedup&lt;/h3>
&lt;h3 id="btrfs-dedup">&lt;span class="section-num">2.4&lt;/span> btrfs-dedup&lt;/h3>
&lt;h2 id="дедупликация-на-уровне-файлов">&lt;span class="section-num">3&lt;/span> Дедупликация на уровне файлов&lt;/h2>
&lt;ul>
&lt;li>Некоторые утилиты для дедупликации на уровне файлов поддерживают файловую систему &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2022/05/26/file-deduplication-linux/">Дедупликация файлов в Linux&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Файл подкачки на btrfs</title><link>https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/</link><pubDate>Fri, 20 May 2022 10:29:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/</guid><description>&lt;p>Размещение файла подкачки на разделе &lt;em>btrfs&lt;/em>.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#создание-файла-подкачки">&lt;span class="section-num">2&lt;/span> Создание файла подкачки&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;ul>
&lt;li>btrfs поддерживает файл подкачки (начиная с ядра версии 5.0).&lt;/li>
&lt;li>Файл подкачки &lt;strong>не может&lt;/strong> находиться на любом рейде btrfs.&lt;/li>
&lt;li>btrfs не позволяет создавать снапшоты, если на подтоме есть рабочий файл подкачки.&lt;/li>
&lt;li>Рекомендуется размещать файл подкачки на отдельном подтоме.&lt;/li>
&lt;li>Файл подкачки должен иметь свойство NODATACOW.&lt;/li>
&lt;li>Файл подкачки должен быть без сжатия.&lt;/li>
&lt;/ul>
&lt;h2 id="создание-файла-подкачки">&lt;span class="section-num">2&lt;/span> Создание файла подкачки&lt;/h2>
&lt;ul>
&lt;li>Подмонтируем раздел с btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/gentoo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,space_cache,discard,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9 /dev/sda4 /mnt/gentoo/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим подтом для файла подкачки на btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отмонтируем том btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">umount /mnt/gentoo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим точку монтирования:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем подтом &lt;code>@swap&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -o &lt;span class="nv">subvol&lt;/span>&lt;span class="o">=&lt;/span>@swap /dev/sda4 /swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отключим для этого подтома CoW:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chattr +C /swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">truncate -s &lt;span class="m">0&lt;/span> /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отключим сжатие:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs property &lt;span class="nb">set&lt;/span> /swap/swapfile compression &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Установим права доступа &lt;code>600&lt;/code> к файлу подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Установим размер файла подкачки.
&lt;ul>
&lt;li>Можно задать размер вручную (например, 4GiB):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fallocate -l 4G /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Можно установить размер файла подкачки исходя из размера оперативной памяти:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fallocate -l &lt;span class="k">$(&lt;/span>free -h --si &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Отформатируем файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkswap /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Активируем файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">swapon /swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Добавим запись в &lt;code>/etc/fstab&lt;/code>, чтобы подключать файл подкачки при загрузке (для устройства с &lt;code>UUID=&amp;quot;f8963df3-1320-4bc0-a125-62be185b029e&amp;quot;&lt;/code>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">UUID=&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34; /swap btrfs relatime,discard,autodefrag,compress=zstd:9,subvol=@swap 0 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/swap/swapfile none swap sw 0 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Проверьте, что файл &lt;code>/etc/fstab&lt;/code> не содержит ошибок:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">findmnt --verify --verbose
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul></description></item><item><title>Обслуживание btrfs</title><link>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</link><pubDate>Thu, 23 Sep 2021 10:22:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/</guid><description>&lt;p>Действия по обслуживанию Btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#проверка-целостности">&lt;span class="section-num">1&lt;/span> Проверка целостности&lt;/a>&lt;/li>
&lt;li>&lt;a href="#дефрагментация">&lt;span class="section-num">2&lt;/span> Дефрагментация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#trim">&lt;span class="section-num">3&lt;/span> Trim&lt;/a>&lt;/li>
&lt;li>&lt;a href="#балансировка">&lt;span class="section-num">4&lt;/span> Балансировка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#скрипт-btrfsmaintenance">&lt;span class="section-num">5&lt;/span> Скрипт btrfsmaintenance&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">5.1&lt;/span> Общая информация&lt;/a>&lt;/li>
&lt;li>&lt;a href="#установка">&lt;span class="section-num">5.2&lt;/span> Установка&lt;/a>&lt;/li>
&lt;li>&lt;a href="#запуск">&lt;span class="section-num">5.3&lt;/span> Запуск&lt;/a>&lt;/li>
&lt;li>&lt;a href="#удаление">&lt;span class="section-num">5.4&lt;/span> Удаление&lt;/a>&lt;/li>
&lt;li>&lt;a href="#фалы-конфигурации">&lt;span class="section-num">5.5&lt;/span> Фалы конфигурации&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="проверка-целостности">&lt;span class="section-num">1&lt;/span> Проверка целостности&lt;/h2>
&lt;ul>
&lt;li>Следующая команда считывает все блоки данных и метаданных со всех устройств и проверяет контрольные суммы:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs scrub start -Bd &amp;lt;путь&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Автоматически восстанавливает поврежденные блоки, если есть правильная копия.&lt;/li>
&lt;li>Не является средством проверки файловой системы (fsck) и не проверяет и не устраняет структурные повреждения в файловой системе.&lt;/li>
&lt;li>Пользователь должен запускать его вручную или через периодическую системную службу. Рекомендуемый период составляет месяц, но может быть и меньше.&lt;/li>
&lt;/ul>
&lt;h2 id="дефрагментация">&lt;span class="section-num">2&lt;/span> Дефрагментация&lt;/h2>
&lt;ul>
&lt;li>При первой записи Btrfs записывает данные последовательно.&lt;/li>
&lt;li>Механизм COW (Copy-On-Write) подразумевает, что любая последующая модификация файла не должна быть написана поверх старых данных, и соответственно, она помещается в свободный блок.&lt;/li>
&lt;li>Данное обстоятельство вызывает повышенную фрагментацию файловой системы.&lt;/li>
&lt;li>В Btrfs для борьбы с фрагментацией существует несколько методов:
&lt;ul>
&lt;li>дефрагментация с помощью команды
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs filesystem defragment &amp;lt;путь&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>опция монтирования &lt;code>-o nodatacow&lt;/code>, которая отключает COW для данных.
&lt;ul>
&lt;li>Можно применять к отдельному файлу либо к подтому/директории, в том числе рекурсивно.&lt;/li>
&lt;li>Атрибут &lt;code>nocow&lt;/code> можно также выставить новому или пустому файлу.&lt;/li>
&lt;li>Он отключает механизм &lt;em>copy on write&lt;/em>, благодаря чему Btrfs при обновлении содержимого файла будет всегда работать с фиксированной дисковой областью, записывая данные поверх существующих (на физическом уровне).&lt;/li>
&lt;li>Включение атрибута &lt;code>nocow&lt;/code> отключает проверку контрольной суммы файлов.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>опция монтирования &lt;code>-o autodefrag&lt;/code>.
&lt;ul>
&lt;li>Обнаруживает небольшие случайные записи в файлы и ставит их в очередь для автоматического дефрагментации, поэтому файловая система будет дефрагментировать себя, пока она используется.&lt;/li>
&lt;li>Не подходит для виртуализации или высоконагруженных баз данных, но хорошо работает для небольших файлов.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Оценить фрагментированность файлов можно при помощи утилиты &lt;code>filefrag&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h2 id="trim">&lt;span class="section-num">3&lt;/span> Trim&lt;/h2>
&lt;ul>
&lt;li>Btrfs может передавать SSD информацию о том, какие блоки данных больше не используются (удалённые файлы и т.д.).&lt;/li>
&lt;li>Это позволяет избежать постепенного снижения производительности SSD.&lt;/li>
&lt;li>Операция &lt;code>fstrim&lt;/code> предназначена для таких целей. Для большинства современных SSD она доступна.&lt;/li>
&lt;li>Btrfs автоматически определяет при монтировании твердотельные накопители.&lt;/li>
&lt;li>Для работы &lt;code>fstrim&lt;/code> необходим ручной запуск или установка опции монтирования &lt;code>-o discard&lt;/code>, которая будет запускать &lt;code>fstrim&lt;/code> после каждого удаления файла.&lt;/li>
&lt;/ul>
&lt;h2 id="балансировка">&lt;span class="section-num">4&lt;/span> Балансировка&lt;/h2>
&lt;ul>
&lt;li>Основной целью функции &lt;code>balance&lt;/code> является распределение групп блоков по всем устройствам.&lt;/li>
&lt;li>Работает только на смонтированной файловой системе.&lt;/li>
&lt;li>Btrfs использует двуступенчатый распределитель:
&lt;ul>
&lt;li>на первом этапе выделяются большие области пространства, известные как чанки (chunks) для определенных типов данных;&lt;/li>
&lt;li>на втором этапе выделяются блоки (blocks).&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Существует три типа чанков:
&lt;ul>
&lt;li>Data chunks хранят обычные данные файла.&lt;/li>
&lt;li>Metadata Chunks хранят метаданные о файлах, включая, метки времени, контрольные суммы, имена файлов, владельца, разрешения и расширенные атрибуты.&lt;/li>
&lt;li>System Chunks это особый тип чанков, которые хранят данные о том, где находятся все остальные чанки.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Только тот тип данных, для которого выделен блок, может быть сохранен в этом блоке.&lt;/li>
&lt;li>Ошибка &lt;code>ENOSPC&lt;/code> в Btrfs. Файловая система исчерпала пространство для данных или метаданных в существующих чанках и не может выделить новый чанк.
&lt;ul>
&lt;li>Запустите &lt;code>btrfs fi df &amp;lt;путь&amp;gt;&lt;/code> в файловой системе, которая вызвала ошибку.&lt;/li>
&lt;li>Если в строке &amp;ldquo;Данные&amp;rdquo; или &amp;ldquo;Метаданные&amp;rdquo; отображается значение &amp;ldquo;Итого&amp;rdquo;, которое значительно отличается от значения &amp;ldquo;Используется&amp;rdquo;, то это, вероятно, является причиной.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Команда &lt;code>btrfs balance&lt;/code> отправляет данные обратно через распределитель (allocator), что приводит к более компактному использованию чанков.&lt;/li>
&lt;li>Если запустить &lt;code>btrfs fi df &amp;lt;путь&amp;gt;&lt;/code> после запуска баланса, значения Total и Used станут намного ближе друг к другу, так как баланс удаляет фрагменты, которые больше не нужны.&lt;/li>
&lt;/ul>
&lt;h2 id="скрипт-btrfsmaintenance">&lt;span class="section-num">5&lt;/span> Скрипт btrfsmaintenance&lt;/h2>
&lt;h3 id="общая-информация">&lt;span class="section-num">5.1&lt;/span> Общая информация&lt;/h3>
&lt;ul>
&lt;li>Выполняемые действия:
&lt;ul>
&lt;li>периодическая проверка целостности;&lt;/li>
&lt;li>периодическая балансировка;&lt;/li>
&lt;li>периодический trim для SSD;&lt;/li>
&lt;li>периодическая дефрагментация.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Репозиторий: &lt;a href="https://github.com/kdave/btrfsmaintenance" target="_blank" rel="noopener">https://github.com/kdave/btrfsmaintenance&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="установка">&lt;span class="section-num">5.2&lt;/span> Установка&lt;/h3>
&lt;ul>
&lt;li>Gentoo Linux
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">emerge sys-fs/btrfsmaintenance
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="запуск">&lt;span class="section-num">5.3&lt;/span> Запуск&lt;/h3>
&lt;ul>
&lt;li>Следует выбрать один из вариантов.&lt;/li>
&lt;li>Обновление таймеров через &lt;em>systemd&lt;/em> (при каждой загрузке системы):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> --now btrfsmaintenance-refresh.path
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Ручное обновление таймеров через &lt;em>systemd&lt;/em>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh systemd-timer
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Ручное обновление таблиц через &lt;em>crond&lt;/em> (без &lt;em>systemd&lt;/em>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="удаление">&lt;span class="section-num">5.4&lt;/span> Удаление&lt;/h3>
&lt;ul>
&lt;li>Данные действия выполняют обычно менеджеры пакетов.&lt;/li>
&lt;li>Для удаления всех таймеров запустите:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/usr/share/btrfsmaintenance/btrfsmaintenance-refresh-cron.sh uninstall
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="фалы-конфигурации">&lt;span class="section-num">5.5&lt;/span> Фалы конфигурации&lt;/h3>
&lt;ul>
&lt;li>В зависимости от дистрибутива конфигурация может находиться в следующих файлах:
&lt;ul>
&lt;li>&lt;code>/etc/sysconfig/btrfsmaintenance&lt;/code>: RedHat, SUSE и производные;&lt;/li>
&lt;li>&lt;code>/etc/default/btrfsmaintenance&lt;/code>: Debian и производные, Gentoo.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>В качестве шаблона для этих файлов используется &lt;code>sysconfig.btrfsmaintenance&lt;/code>.&lt;/li>
&lt;/ul></description></item><item><title>Подтома btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</link><pubDate>Fri, 27 Aug 2021 11:41:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/</guid><description>&lt;p>Подтома (subvolumes) btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#именование-подтомов">&lt;span class="section-num">1&lt;/span> Именование подтомов&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#список-подтомов">&lt;span class="section-num">1.1&lt;/span> Список подтомов&lt;/a>&lt;/li>
&lt;li>&lt;a href="#минимально-рекомендуемый-набор-подтомов">&lt;span class="section-num">1.2&lt;/span> Минимально рекомендуемый набор подтомов&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#создание-подтомов">&lt;span class="section-num">2&lt;/span> Создание подтомов&lt;/a>&lt;/li>
&lt;li>&lt;a href="#отключение-cow">&lt;span class="section-num">3&lt;/span> Отключение CoW&lt;/a>&lt;/li>
&lt;li>&lt;a href="#монтирование-подтомов-в-fstab">&lt;span class="section-num">4&lt;/span> Монтирование подтомов в fstab&lt;/a>&lt;/li>
&lt;li>&lt;a href="#создание-нового-подтома">&lt;span class="section-num">5&lt;/span> Создание нового подтома&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="именование-подтомов">&lt;span class="section-num">1&lt;/span> Именование подтомов&lt;/h2>
&lt;ul>
&lt;li>Для определённости я называю подтома по шаблону &lt;code>@имя_подтома&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h3 id="список-подтомов">&lt;span class="section-num">1.1&lt;/span> Список подтомов&lt;/h3>
&lt;div class="table-caption">
&lt;span class="table-number">&amp;#1058;&amp;#1072;&amp;#1073;&amp;#1083;&amp;#1080;&amp;#1094;&amp;#1072; 1:&lt;/span>
Возможные наименования подтомов btrfs
&lt;/div>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Подтом&lt;/th>
&lt;th>Точка монтирования&lt;/th>
&lt;th>Описание&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>@&lt;/code>&lt;/td>
&lt;td>&lt;code>/&lt;/code>&lt;/td>
&lt;td>Корневой каталог (системные файлы)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@home&lt;/code>&lt;/td>
&lt;td>&lt;code>/home&lt;/code>&lt;/td>
&lt;td>Домашний каталог с пользовательскими данными&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@root&lt;/code>&lt;/td>
&lt;td>&lt;code>/root&lt;/code>&lt;/td>
&lt;td>Домашний каталог пользователя &lt;code>root&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots&lt;/code>&lt;/td>
&lt;td>‒&lt;/td>
&lt;td>Корневой подтом для снапшотов&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots@root&lt;/code>&lt;/td>
&lt;td>&lt;code>/.snapshots&lt;/code>&lt;/td>
&lt;td>Содержит снапшоты корня, которые создает &lt;code>snapper&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@snapshots@home&lt;/code>&lt;/td>
&lt;td>&lt;code>/home/.snapshots&lt;/code>&lt;/td>
&lt;td>Содержит снапшоты домашнего каталога, которые создает &lt;code>snapper&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@machines&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/machines&lt;/code>&lt;/td>
&lt;td>Если не существует, то создаст systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@portables&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/portables&lt;/code>&lt;/td>
&lt;td>Если не существует, то создаст systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@docker&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/docker&lt;/code>&lt;/td>
&lt;td>Докер создаёт подтома в &lt;code>./btrfs/subvolumes&lt;/code> либо в &lt;code>./XXX/btrfs/subvolumes&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var&lt;/code>&lt;/td>
&lt;td>&lt;code>/var&lt;/code>&lt;/td>
&lt;td>Аналогично выше описанному&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var@lib&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib&lt;/code>&lt;/td>
&lt;td>Вместо создания &lt;code>@machines&lt;/code>, &lt;code>@portables&lt;/code>, &lt;code>@docker&lt;/code> можно создать только этот, если в &lt;code>/var/lib&lt;/code> не будет храниться чего-то важного&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var@tmp&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/tmp&lt;/code>&lt;/td>
&lt;td>Содержит временные файлы. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@var@log&lt;/code> или &lt;code>@log&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/log&lt;/code>&lt;/td>
&lt;td>Содержит большое количество файлов, которые пишутся маленькими частями. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@swap&lt;/code>&lt;/td>
&lt;td>&lt;code>/swap&lt;/code> или &lt;code>/var/swap&lt;/code>, или &lt;code>/var/lib/swap&lt;/code>&lt;/td>
&lt;td>Подтом для файла подкачки. Должен монтироваться с &lt;code>nodatacow&lt;/code> (см. &lt;a href="https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/">Файл подкачки на btrfs&lt;/a>)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>@libvirt&lt;/code>&lt;/td>
&lt;td>&lt;code>/var/lib/libvirt/images&lt;/code>&lt;/td>
&lt;td>Образы для &lt;em>libvirt&lt;/em>. Должен монтироваться с &lt;code>nodatacow&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="минимально-рекомендуемый-набор-подтомов">&lt;span class="section-num">1.2&lt;/span> Минимально рекомендуемый набор подтомов&lt;/h3>
&lt;ul>
&lt;li>Минимум нужны два подтома: &lt;code>@&lt;/code> и &lt;code>@home&lt;/code>.&lt;/li>
&lt;/ul>
&lt;h2 id="создание-подтомов">&lt;span class="section-num">2&lt;/span> Создание подтомов&lt;/h2>
&lt;ul>
&lt;li>При установки системы я создаю подтома следующим образом:
&lt;ul>
&lt;li>Подмонтируем раздел с btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/gentoo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9 /dev/sdc2 /mnt/gentoo/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим подтома на btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var@tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var@log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @vm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage@local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage@com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @libvirt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @home
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="отключение-cow">&lt;span class="section-num">3&lt;/span> Отключение CoW&lt;/h2>
&lt;ul>
&lt;li>Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write).&lt;/li>
&lt;li>Так же стоит отключить &lt;em>CoW&lt;/em> для часто изменяемых файлов (например, журналов).&lt;/li>
&lt;li>Подмонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@vm /dev/sdc2 /mnt/gentoo/var/vm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@libvirt /dev/sdc2 /mnt/gentoo/var/lib/libvirt/images
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var@log /dev/sdc2 /mnt/gentoo/var/log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отключим для этого подтома CoW:
&lt;ul>
&lt;li>Для &lt;code>/var/vm&lt;/code>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C vm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Для &lt;code>/var/lib/libvirt/images&lt;/code>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/lib/libvirt/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C images
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Для &lt;code>/var/log&lt;/code>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Для &lt;code>/var/tmp&lt;/code>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C tmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Посмотреть результат можно командой:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">lsattr -a /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="монтирование-подтомов-в-fstab">&lt;span class="section-num">4&lt;/span> Монтирование подтомов в fstab&lt;/h2>
&lt;ul>
&lt;li>При монтировании я указываю универсальный идентификатор (UUID) файловой системы:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/fstab&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="k">var&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tmp&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">var_tmp&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">vm&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">home&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage_local&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage_com&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">libvirt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">images&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">libvirt&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Идентификатор файловой системы можно узнать следующим образом:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">blkid /dev/sdc2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="создание-нового-подтома">&lt;span class="section-num">5&lt;/span> Создание нового подтома&lt;/h2>
&lt;ul>
&lt;li>После установки системы может возникнуть необходимость создания дополнительных подтомов на существующем томе.
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/btrfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount &lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>f8963df3-1320-4bc0-a125-62be185b029e /mnt/btrfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvolume create /mnt/btrfs/@data
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подключим в &lt;code>/etc/fstab&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;f8963df3-1320-4bc0-a125-62be185b029e&amp;#34;&lt;/span> /data btrfs relatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@data &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul></description></item><item><title>Файловая система btrfs</title><link>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</link><pubDate>Fri, 27 Aug 2021 11:33:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/08/27/btrfs-file-system/</guid><description>&lt;p>Файловая система &lt;em>Btrfs&lt;/em>.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#свойства">&lt;span class="section-num">1.1&lt;/span> Свойства&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#опции-монтирования">&lt;span class="section-num">2&lt;/span> Опции монтирования&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#ssd-trim">&lt;span class="section-num">2.1&lt;/span> SSD TRIM&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#разное">&lt;span class="section-num">3&lt;/span> Разное&lt;/a>&lt;/li>
&lt;li>&lt;a href="#обслуживание-btrfs">&lt;span class="section-num">4&lt;/span> Обслуживание btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="#необходимое-программное-обеспечение">&lt;span class="section-num">5&lt;/span> Необходимое программное обеспечение&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#btrfs-progs">&lt;span class="section-num">5.1&lt;/span> btrfs-progs&lt;/a>&lt;/li>
&lt;li>&lt;a href="#btrfsmaintenance">&lt;span class="section-num">5.2&lt;/span> btrfsmaintenance&lt;/a>&lt;/li>
&lt;li>&lt;a href="#snapper">&lt;span class="section-num">5.3&lt;/span> snapper&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#ресурсы">&lt;span class="section-num">6&lt;/span> Ресурсы&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="общая-информация">&lt;span class="section-num">1&lt;/span> Общая информация&lt;/h2>
&lt;h3 id="свойства">&lt;span class="section-num">1.1&lt;/span> Свойства&lt;/h3>
&lt;ul>
&lt;li>Копирование при записи (copy on write &amp;mdash; CoW).
&lt;ul>
&lt;li>Все копии файла суммарно занимают на диске столько же места сколько оригинал, а при изменениях файлов данные всегда пишутся в новые страницы.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Снапшоты.
&lt;ul>
&lt;li>Можно делать снимки состояния подтома на лету, а потом вернуть это состояние, например, после неудачного обновления или удаления чего-то нужного, просто отредактировав &lt;code>/etc/fstab&lt;/code> и выполнив &lt;code>mount -o remount mountpoint&lt;/code>.&lt;/li>
&lt;li>Для автоматического создания снапшотов можно использовать утилиту &lt;code>snapper&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Поддержка сжатия.&lt;/li>
&lt;li>Поддержка подтомов.
&lt;ul>
&lt;li>Вместо разделов предпочтительно использовать подтома.&lt;/li>
&lt;li>Подтома имеют динамический размер.&lt;/li>
&lt;li>Снапшоты являются по сути подтомами.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Поддержка дисков SSD.&lt;/li>
&lt;/ul>
&lt;h2 id="опции-монтирования">&lt;span class="section-num">2&lt;/span> Опции монтирования&lt;/h2>
&lt;h3 id="ssd-trim">&lt;span class="section-num">2.1&lt;/span> SSD TRIM&lt;/h3>
&lt;ul>
&lt;li>Файловая система Btrfs может освобождать неиспользуемые блоки с SSD диска, поддерживающего команду TRIM.&lt;/li>
&lt;li>Поддерживается асинхронный discard, который доступен в виде опции монтирования &lt;code>discard=async&lt;/code>.
&lt;ul>
&lt;li>Включено по умолчанию начиная с linux 6.2.&lt;/li>
&lt;li>Незанятые экстенты не освобождаются сразу, а группируются и освобождаются позже в отдельном потоке, что улучшает задержки при записи на диск.&lt;/li>
&lt;li>Асинхронный discard можно безопасно использовать вместе с периодическим TRIM.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="разное">&lt;span class="section-num">3&lt;/span> Разное&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/">Перенос Linux на btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/">Подтома btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/">btrfs. Контрольные суммы&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="обслуживание-btrfs">&lt;span class="section-num">4&lt;/span> Обслуживание btrfs&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2021/09/23/btrfs-maintenence/">Обслуживание btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2022/05/26/deduplication-btrfs-filesystem/">Дедупликация файловой системы btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yamadharma.github.io/ru/post/2023/07/21/btrfs-recovery/">Восстановление btrfs&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="необходимое-программное-обеспечение">&lt;span class="section-num">5&lt;/span> Необходимое программное обеспечение&lt;/h2>
&lt;h3 id="btrfs-progs">&lt;span class="section-num">5.1&lt;/span> btrfs-progs&lt;/h3>
&lt;ul>
&lt;li>Утилиты для работы с &lt;em>btrfs&lt;/em>.&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">emerge sys-fs/btrfs-progs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="btrfsmaintenance">&lt;span class="section-num">5.2&lt;/span> btrfsmaintenance&lt;/h3>
&lt;ul>
&lt;li>Скрипт для регулярного обслуживания файловой системы &lt;em>btrfs&lt;/em>&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">emerge sys-fs/btrfsmaintenance
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="snapper">&lt;span class="section-num">5.3&lt;/span> snapper&lt;/h3>
&lt;ul>
&lt;li>Управление снапшотами&lt;/li>
&lt;li>Установка
&lt;ul>
&lt;li>Gentoo
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">emerge app-backup/snapper
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="ресурсы">&lt;span class="section-num">6&lt;/span> Ресурсы&lt;/h2>
&lt;ul>
&lt;li>Документация: &lt;a href="https://btrfs.readthedocs.io/" target="_blank" rel="noopener">https://btrfs.readthedocs.io/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Перенос Linux на btrfs</title><link>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</link><pubDate>Fri, 21 May 2021 20:38:00 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2021/05/21/installing-linux-btrfs/</guid><description>&lt;p>Перенос Gentoo Linux с одного диска на другой. На новом диске делается система btrfs.&lt;/p>
&lt;details class="print:hidden xl:hidden" >
&lt;summary>Содержание&lt;/summary>
&lt;div class="text-sm">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#исходное-состояние-системы">&lt;span class="section-num">1&lt;/span> Исходное состояние системы&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#система-на-lvm">&lt;span class="section-num">1.1&lt;/span> Система на LVM&lt;/a>&lt;/li>
&lt;li>&lt;a href="#система-на-btrfs">&lt;span class="section-num">1.2&lt;/span> Система на btrfs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#разбиение-диска">&lt;span class="section-num">2&lt;/span> Разбиение диска&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#выделенная-boot-партиция">&lt;span class="section-num">2.1&lt;/span> Выделенная boot-партиция&lt;/a>&lt;/li>
&lt;li>&lt;a href="#все-разделы-на-файловой-системе-btrfs">&lt;span class="section-num">2.2&lt;/span> Все разделы на файловой системе btrfs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#подготовка-раздела-с-btrfs">&lt;span class="section-num">3&lt;/span> Подготовка раздела с btrfs&lt;/a>&lt;/li>
&lt;li>&lt;a href="#копирование-существующих-файловых-систем">&lt;span class="section-num">4&lt;/span> Копирование существующих файловых систем&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#система-на-lvm">&lt;span class="section-num">4.1&lt;/span> Система на LVM&lt;/a>&lt;/li>
&lt;li>&lt;a href="#система-на-btrfs">&lt;span class="section-num">4.2&lt;/span> Система на btrfs&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#подготовка-к-копированию">&lt;span class="section-num">4.2.1&lt;/span> Подготовка к копированию&lt;/a>&lt;/li>
&lt;li>&lt;a href="#копирование-основных-файловых-систем">&lt;span class="section-num">4.2.2&lt;/span> Копирование основных файловых систем&lt;/a>&lt;/li>
&lt;li>&lt;a href="#копируем-portage">&lt;span class="section-num">4.2.3&lt;/span> Копируем portage&lt;/a>&lt;/li>
&lt;li>&lt;a href="#копируем-системы-с-отключением-cow">&lt;span class="section-num">4.2.4&lt;/span> Копируем системы с отключением CoW&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#установка-загрузчика">&lt;span class="section-num">5&lt;/span> Установка загрузчика&lt;/a>&lt;/li>
&lt;li>&lt;a href="#файл-монтирования-fstab">&lt;span class="section-num">6&lt;/span> Файл монтирования fstab&lt;/a>&lt;/li>
&lt;li>&lt;a href="#файл-подкачки-на-файловой-системе-btrfs">&lt;span class="section-num">7&lt;/span> Файл подкачки на файловой системе btrfs&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#подготовка-к-созданию-файла-подкачки">&lt;span class="section-num">7.1&lt;/span> Подготовка к созданию файла подкачки&lt;/a>&lt;/li>
&lt;li>&lt;a href="#создание-файла-подкачки">&lt;span class="section-num">7.2&lt;/span> Создание файла подкачки&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#старый-подход">&lt;span class="section-num">7.2.1&lt;/span> Старый подход&lt;/a>&lt;/li>
&lt;li>&lt;a href="#новый-подход">&lt;span class="section-num">7.2.2&lt;/span> Новый подход&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#активация-файла-подкачки">&lt;span class="section-num">7.3&lt;/span> Активация файла подкачки&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;/details>
&lt;h2 id="исходное-состояние-системы">&lt;span class="section-num">1&lt;/span> Исходное состояние системы&lt;/h2>
&lt;ul>
&lt;li>Переносил несколько вариантов исходных систем.&lt;/li>
&lt;/ul>
&lt;h3 id="система-на-lvm">&lt;span class="section-num">1.1&lt;/span> Система на LVM&lt;/h3>
&lt;ul>
&lt;li>Исходно система установлена на LVM:
&lt;ul>
&lt;li>&lt;code>/dev/sda1&lt;/code>: &lt;code>/boot/EFI&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/sda2&lt;/code>: &lt;code>/boot&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/root&lt;/code>: &lt;code>/&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/var&lt;/code>: &lt;code>/var&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/var_tmp&lt;/code>: &lt;code>/var/tmp&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/vm&lt;/code>: &lt;code>/var/vm&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage&lt;/code>: &lt;code>/usr/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage_local&lt;/code>: &lt;code>/usr/local/share/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/portage_com&lt;/code>: &lt;code>/com/lib/portage&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/vgs/home&lt;/code>: &lt;code>/home&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="система-на-btrfs">&lt;span class="section-num">1.2&lt;/span> Система на btrfs&lt;/h3>
&lt;ul>
&lt;li>Система на btrfs:
&lt;ul>
&lt;li>&lt;code>/dev/sda1&lt;/code>: &lt;code>/boot/EFI&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/sda2&lt;/code>: &lt;code>/boot&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/sda3&lt;/code>: &lt;code>swap&lt;/code>;&lt;/li>
&lt;li>&lt;code>/dev/sda4&lt;/code>: партиция с файловой системой btrfs.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="разбиение-диска">&lt;span class="section-num">2&lt;/span> Разбиение диска&lt;/h2>
&lt;ul>
&lt;li>Установим тип разбиения в GPT.&lt;/li>
&lt;/ul>
&lt;h3 id="выделенная-boot-партиция">&lt;span class="section-num">2.1&lt;/span> Выделенная boot-партиция&lt;/h3>
&lt;ul>
&lt;li>Разобьём на партиции:
&lt;ul>
&lt;li>p1 &amp;mdash; 512M, для &lt;code>EFI&lt;/code>.&lt;/li>
&lt;li>p2 &amp;mdash; 500&amp;ndash;1024M, для &lt;code>/boot&lt;/code>.&lt;/li>
&lt;li>p3 &amp;mdash; двойная оперативная память, для &lt;code>swap&lt;/code>.
&lt;ul>
&lt;li>Также можно разместить файл подкачки на &lt;code>btrfs&lt;/code> (см. &lt;a href="https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/">Файл подкачки на btrfs&lt;/a>).&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>p4 &amp;mdash; всё остальное для &lt;code>btrfs&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Создадим файловые системы:
&lt;ul>
&lt;li>p1 (&lt;code>EFI&lt;/code>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkfs.vfat -F32 -n EFI /dev/sdc1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>p2 (&lt;code>/boot&lt;/code>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkfs.ext4 -L boot /dev/sdc2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>p3 (&lt;code>swap&lt;/code> в случае отдельной партиции):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkswap -L swap /dev/sdc3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>p4 (&lt;code>btrfs&lt;/code>)
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkfs.btrfs /dev/sdc4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="все-разделы-на-файловой-системе-btrfs">&lt;span class="section-num">2.2&lt;/span> Все разделы на файловой системе btrfs&lt;/h3>
&lt;ul>
&lt;li>Разобьём на партиции:
&lt;ul>
&lt;li>p1 &amp;mdash; 1024M, для &lt;code>EFI&lt;/code>.&lt;/li>
&lt;li>Файл подкачки на &lt;code>btrfs&lt;/code> (см. &lt;a href="https://yamadharma.github.io/ru/post/2022/05/20/btrfs-swap-file/">Файл подкачки на btrfs&lt;/a>).&lt;/li>
&lt;li>p4 &amp;mdash; всё остальное для &lt;code>btrfs&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Разобьём диск:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sgdisk -n 0:0:+1024M -t 0:ef00 -c 0:EFI /dev/sdc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sgdisk -n 0:0:0 -t 0:8300 -c 0:gentoo /dev/sdc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим файловые системы:
&lt;ul>
&lt;li>p1 (&lt;code>EFI&lt;/code>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkfs.vfat -F32 -n EFI /dev/sdc1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>p2 (&lt;code>btrfs&lt;/code>) (см. &lt;a href="https://yamadharma.github.io/ru/post/2024/02/19/btrfs-checksumming/">btrfs. Контрольные суммы&lt;/a>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkfs.btrfs --checksum blake2 -L gentoo /dev/sdc2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="подготовка-раздела-с-btrfs">&lt;span class="section-num">3&lt;/span> Подготовка раздела с btrfs&lt;/h2>
&lt;ul>
&lt;li>Подмонтируем раздел с btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9 /dev/sdc2 /mnt/to/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим подтома на btrfs (см. &lt;a href="https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/">Подтома btrfs&lt;/a>):
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/to/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var@tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @var@log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @vm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @libvirt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подтома для &lt;em>Gentoo Linux&lt;/em>.&lt;/li>
&lt;li>Используется, если &lt;em>portage&lt;/em> размещается локально:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/to/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage@local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @portage@com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Если используется файл подкачки на файловой системе, то создадим для него подтом:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/to/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs subvol create @swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="копирование-существующих-файловых-систем">&lt;span class="section-num">4&lt;/span> Копирование существующих файловых систем&lt;/h2>
&lt;h3 id="система-на-lvm">&lt;span class="section-num">4.1&lt;/span> Система на LVM&lt;/h3>
&lt;ul>
&lt;li>Создадим точку монтирования:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/from
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем root-партицию:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/vgs/root /mnt/from/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/ /mnt/to/@
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/from/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>/var&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/vgs/var /mnt/from/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/ /mnt/to/@var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/from/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>/boot&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/to/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/sdc2 /mnt/to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/sdb2 /mnt/from/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/ /mnt/to/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/from
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>portage&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/vgs/portage /mnt/from/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/ /mnt/to/@portage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/from/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>portage_local&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/vgs/portage_local /mnt/from/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/ /mnt/to/@portage_local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/from/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="система-на-btrfs">&lt;span class="section-num">4.2&lt;/span> Система на btrfs&lt;/h3>
&lt;h4 id="подготовка-к-копированию">&lt;span class="section-num">4.2.1&lt;/span> Подготовка к копированию&lt;/h4>
&lt;ul>
&lt;li>Создадим точки монтирования:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/from
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем исходную файловую систему btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount /dev/sda4 /mnt/from/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="копирование-основных-файловых-систем">&lt;span class="section-num">4.2.2&lt;/span> Копирование основных файловых систем&lt;/h4>
&lt;ul>
&lt;li>Скопируем root-партицию:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS -AX --delete /mnt/from/@/* /mnt/to/@
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Скопируем &lt;code>/var&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS -AX --delete /mnt/from/@var/* /mnt/to/@var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем и скопируем &lt;code>/boot&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/sda2 /mnt/boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/boot/* /mnt/to/@boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">umount /mnt/boot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="копируем-portage">&lt;span class="section-num">4.2.3&lt;/span> Копируем portage&lt;/h4>
&lt;ul>
&lt;li>Если &lt;code>portage&lt;/code> размещён локально, то его тоже надо скопировать.&lt;/li>
&lt;li>Скопируем &lt;code>@portage&lt;/code>:&lt;/li>
&lt;/ul>
&lt;!--listend-->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/@portage/* /mnt/to/@portage
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Скопируем &lt;code>@portage@local&lt;/code>:&lt;/li>
&lt;/ul>
&lt;!--listend-->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS --delete /mnt/from/@portage@local/* /mnt/to/@portage@local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="копируем-системы-с-отключением-cow">&lt;span class="section-num">4.2.4&lt;/span> Копируем системы с отключением CoW&lt;/h4>
&lt;ul>
&lt;li>Для файловых систем с образами виртуальных машин следует отключить CoW (copy-on-write) (см. &lt;a href="https://yamadharma.github.io/ru/post/2021/08/27/btrfs-subvolumes/">Подтома btrfs&lt;/a>).&lt;/li>
&lt;li>Так же стоит отключить &lt;em>CoW&lt;/em> для часто изменяемых файлов (например, журналов).&lt;/li>
&lt;li>Подмонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/gentoo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@ /dev/sdc2 /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var /dev/sdc2 /mnt/gentoo/var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@vm /dev/sdc2 /mnt/gentoo/var/vm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@libvirt /dev/sdc2 /mnt/gentoo/var/lib/libvirt/images
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var@log /dev/sdc2 /mnt/gentoo/var/log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;!--list-separator-->
&lt;ol>
&lt;li>
&lt;p>Копирование &lt;code>/var/vm&lt;/code>&lt;/p>
&lt;ul>
&lt;li>Отключим для этого подтома CoW:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C vm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Скопируем &lt;code>/var/vm&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS -AX --delete /mnt/from/@vm/* /mnt/to/@vm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;!--list-separator-->
&lt;ol start="2">
&lt;li>
&lt;p>Копирование &lt;code>/var/lib/libvirt/images&lt;/code>&lt;/p>
&lt;ul>
&lt;li>Отключим для подтома &lt;code>/var/lib/libvirt/images&lt;/code> CoW:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/lib/libvirt/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C images
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Скопируем &lt;code>/var/lib/libvirt/images&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS -AX --delete /mnt/from/@libvirt/* /mnt/to/@libvirt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;!--list-separator-->
&lt;ol start="3">
&lt;li>
&lt;p>Копирование &lt;code>/var/log&lt;/code>&lt;/p>
&lt;ul>
&lt;li>Для &lt;code>/var/log&lt;/code>&lt;/li>
&lt;li>Отключим для подтома &lt;code>/var/log&lt;/code> CoW:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Скопируем &lt;code>/var/log&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rsync -av -HS -AX --delete /mnt/from/@var@log/* /mnt/to/@var@log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;!--list-separator-->
&lt;ol start="4">
&lt;li>
&lt;p>Настройки &lt;code>/var/tmp&lt;/code>&lt;/p>
&lt;ul>
&lt;li>Для &lt;code>/var/tmp&lt;/code>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chattr +C tmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Посмотреть результат можно командой:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">lsattr -a /mnt/gentoo/var/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lsattr -a /mnt/gentoo/var/lib/libvirt/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="установка-загрузчика">&lt;span class="section-num">5&lt;/span> Установка загрузчика&lt;/h2>
&lt;ul>
&lt;li>Перемонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/gentoo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@ /dev/sdc2 /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var /dev/sdc2 /mnt/gentoo/var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@var@tmp /dev/sdc2 /mnt/gentoo/var/tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard&lt;span class="o">=&lt;/span>async,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@boot /dev/sdc2 /mnt/gentoo/boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/sdc1 /mnt/gentoo/boot/efi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем псевдо-файловые системы:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -o &lt;span class="nb">bind&lt;/span> /dev /mnt/gentoo/dev/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -o &lt;span class="nb">bind&lt;/span> /proc /mnt/gentoo/proc/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -o &lt;span class="nb">bind&lt;/span> /sys /mnt/gentoo/sys/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -o &lt;span class="nb">bind&lt;/span> /run /mnt/gentoo/run/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -t efivarfs efivarfs /mnt/gentoo/sys/firmware/efi/efivars
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Установим загрузчик:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chroot /mnt/gentoo/ /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub-install /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub-mkconfig -o /boot/grub/grub.cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="файл-монтирования-fstab">&lt;span class="section-num">6&lt;/span> Файл монтирования fstab&lt;/h2>
&lt;ul>
&lt;li>Создадим файл монтирования fstab.&lt;/li>
&lt;li>Узнаем идентификатор партиции с файловой системой btrfs:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">blkid /dev/sdc2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Получим строчку:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим файл &lt;code>/mnt/to/etc/fstab&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">LABEL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;boot&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">boot&lt;/span> &lt;span class="n">ext4&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">LABEL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;EFI&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">boot&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">efi&lt;/span> &lt;span class="n">vfat&lt;/span> &lt;span class="n">defaults&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">tz&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">UTC&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">LABEL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;swap&amp;#34;&lt;/span> &lt;span class="n">none&lt;/span> &lt;span class="n">swap&lt;/span> &lt;span class="n">sw&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="k">var&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tmp&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">var_tmp&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">vm&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">vm&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">home&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">home&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage_local&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">portage&lt;/span> &lt;span class="n">btrfs&lt;/span> &lt;span class="n">relatime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">discard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">async&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">autodefrag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">zstd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">subvol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="n">portage_com&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Если используется файл подкачки, то вместо отдельной партиции следует подключить этот файл в &lt;code>/mnt/to/etc/fstab&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">UUID=&amp;#34;&amp;lt;uuid_number&amp;gt;&amp;#34; /swap btrfs relatime,discard=async,autodefrag,compress=zstd:9,subvol=@swap 0 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/swap/swapfile none swap sw 0 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="файл-подкачки-на-файловой-системе-btrfs">&lt;span class="section-num">7&lt;/span> Файл подкачки на файловой системе btrfs&lt;/h2>
&lt;h3 id="подготовка-к-созданию-файла-подкачки">&lt;span class="section-num">7.1&lt;/span> Подготовка к созданию файла подкачки&lt;/h3>
&lt;ul>
&lt;li>Для раздела файла подкачки следует отключить CoW (copy-on-write).&lt;/li>
&lt;li>Подмонтируем файловую систему &lt;code>btrfs&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/gentoo/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@ /dev/sdc2 /mnt/gentoo/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим точку монтирования:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir /mnt/gentoo/swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Подмонтируем подтом &lt;code>@swap&lt;/code>:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -tbtrfs -orelatime,discard,autodefrag,compress&lt;span class="o">=&lt;/span>zstd:9,subvol&lt;span class="o">=&lt;/span>@swap /dev/sdc2 /mnt/gentoo/swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отключим для этого подтома CoW:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chattr +C /mnt/gentoo/swap
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="создание-файла-подкачки">&lt;span class="section-num">7.2&lt;/span> Создание файла подкачки&lt;/h3>
&lt;h4 id="старый-подход">&lt;span class="section-num">7.2.1&lt;/span> Старый подход&lt;/h4>
&lt;ul>
&lt;li>Создадим файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">truncate -s &lt;span class="m">0&lt;/span> /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Установим права доступа &lt;code>600&lt;/code> к файлу подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Установим размер файла подкачки исходя из размера оперативной памяти:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fallocate -l &lt;span class="k">$(&lt;/span>free -h --si &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Отформатируем файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkswap /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="новый-подход">&lt;span class="section-num">7.2.2&lt;/span> Новый подход&lt;/h4>
&lt;ul>
&lt;li>Работает начиная с версии утилит 6.1.&lt;/li>
&lt;li>Создадим файл подкачки размером 8ГБ:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs filesystem mkswapfile --size 4g --uuid clear /mnt/gentooswap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>Создадим файл подкачки исходя из размера оперативной памяти:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">btrfs filesystem mkswapfile --size &lt;span class="k">$(&lt;/span>free -h --si &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;NR == 2 {print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> --uuid clear /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="активация-файла-подкачки">&lt;span class="section-num">7.3&lt;/span> Активация файла подкачки&lt;/h3>
&lt;ul>
&lt;li>Активируем файл подкачки:
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">swapon /mnt/gentoo/swap/swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul></description></item></channel></rss>