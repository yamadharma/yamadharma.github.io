<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>samba | Д. С. Кулябов</title><link>https://yamadharma.github.io/ru/tag/samba/</link><atom:link href="https://yamadharma.github.io/ru/tag/samba/index.xml" rel="self" type="application/rss+xml"/><description>samba</description><generator>Wowchemy (https://wowchemy.com)</generator><language>ru-ru</language><copyright>© 2023 Dmitry S. Kulyabov</copyright><lastBuildDate>Tue, 27 Oct 2015 13:48:49 +0300</lastBuildDate><image><url>https://yamadharma.github.io/media/icon_hu0a661dd90139895e92e2f18ae9404407_611148_512x512_fill_lanczos_center_3.png</url><title>samba</title><link>https://yamadharma.github.io/ru/tag/samba/</link></image><item><title>Миграция с Samba3 на Samba4</title><link>https://yamadharma.github.io/ru/post/2015/10/27/samba-migrate/</link><pubDate>Tue, 27 Oct 2015 13:48:49 +0300</pubDate><guid>https://yamadharma.github.io/ru/post/2015/10/27/samba-migrate/</guid><description>&lt;h2 id="установка-пакетов">Установка пакетов&lt;/h2>
&lt;p>В качестве системы для сервера используем Centos7. Там пока не
поддерживается функционал Samba4 AD (конфликт mit-krb и heimdal). Поэтому поставим самбу с
EnterpriseSAMBA.com &lt;a href="https://portal.enterprisesamba.com/" target="_blank" rel="noopener">https://portal.enterprisesamba.com/&lt;/a>.&lt;/p>
&lt;pre>&lt;code class="language-bash">cd /etc/yum.repos.d
wget https://sernet-samba-public:Noo1oxe4zo@download.sernet.de/packages/samba/4.2/rhel/7/sernet-samba-4.2.repo
&lt;/code>&lt;/pre>
&lt;p>В файле &lt;code>/etc/yum.repos.d/sernet-samba-4.2.repo&lt;/code> заменим
&lt;code>USERNAME:ACCESSKEY&lt;/code> на свои данные либо на публичную учётную запись
&lt;code>sernet-samba-public:Noo1oxe4zo&lt;/code>.&lt;/p>
&lt;p>Установим нужные пакеты:&lt;/p>
&lt;pre>&lt;code class="language-bash">yum -y install sernet-samba sernet-samba-ad
yum -y install bind
&lt;/code>&lt;/pre>
&lt;h2 id="поиск-дубликатов-sid">Поиск дубликатов SID&lt;/h2>
&lt;p>Найдём дубликаты SID с помощью следующего скрипта (запусткается на
машине, где расположен ldap).&lt;/p>
&lt;pre>&lt;code class="language-python">#!/usr/bin/python
# A quick and dirty python script that checks for duplicat SID's using slapcat.
import os
data = os.popen(&amp;quot;slapcat | grep sambaSID&amp;quot;, 'r')
line = []
def anydup(thelist):
dups = list(set([x for x in thelist if thelist.count(x) &amp;gt; 1]))
for i in dups:
print &amp;quot;Duplicate id: &amp;quot;, i
for each_line in data:
line.append(each_line.strip())
anydup(line)
&lt;/code>&lt;/pre>
&lt;p>Далее дубликаты удаляются с помощью редактирования ldap (я использовал
&lt;a href="https://directory.apache.org/studio/" target="_blank" rel="noopener">https://directory.apache.org/studio/&lt;/a>).&lt;/p>
&lt;h2 id="предварительная-конфигурация">Предварительная конфигурация&lt;/h2>
&lt;p>Добавил в файл &lt;code>/etc/hosts&lt;/code> адрес хоста.&lt;/p>
&lt;pre>&lt;code>127.0.0.1 localhost.localdomain localhost
10.130.64.23 dc.dk.sci.pfu.edu.ru dc
&lt;/code>&lt;/pre>
&lt;p>Также прописал его в прямой и обратной зонах DNS.&lt;/p>
&lt;h2 id="перенос-конфигурационных-файлов">Перенос конфигурационных файлов&lt;/h2>
&lt;pre>&lt;code class="language-bash">pdc ~ # scp -r /var/lib/samba/private/ dc.dk.sci.pfu.edu.ru:/var/lib/samba/samba3tdb/
pdc ~ # scp /etc/samba/smb.conf dc.dk.sci.pfu.edu.ru:/var/lib/samba/samba3tdb/
&lt;/code>&lt;/pre>
&lt;p>В &lt;code>/var/lib/samba/samba3tdb/smb.conf&lt;/code> следует заменить имя контроллера домена.&lt;/p>
&lt;pre>&lt;code>netbios name = dc
&lt;/code>&lt;/pre>
&lt;p>Поскольку при миграции используется информация из ldap, на хосте &lt;code>dc&lt;/code>
задаю файл &lt;code>/etc/openldap/ldap.conf&lt;/code>.&lt;/p>
&lt;pre>&lt;code>BASE dc=dk,dc=sci,dc=pfu,dc=edu,dc=ru
URI ldap://ldap.dk.sci.pfu.edu.ru
TLS_REQCERT allow
&lt;/code>&lt;/pre>
&lt;h2 id="проведение-миграции">Проведение миграции&lt;/h2>
&lt;pre>&lt;code class="language-bash">samba-tool domain classicupgrade --dbdir=/var/lib/samba/samba3tdb/ --use-xattrs=yes --realm=dk.sci.pfu.edu.ru --dns-backend=BIND9_DLZ /var/lib/samba/samba3tdb/smb.conf
&lt;/code>&lt;/pre>
&lt;h3 id="шаманство">Шаманство&lt;/h3>
&lt;p>В файле &lt;code>/var/lib/samba/samba3tdb/smb.conf&lt;/code> заменил доменное имя&lt;/p>
&lt;pre>&lt;code>passdb backend = ldapsam:ldap://ldap.dk.sci.pfu.edu.ru
&lt;/code>&lt;/pre>
&lt;p>на ip-адрес&lt;/p>
&lt;pre>&lt;code>passdb backend = ldapsam:ldap://10.130.64.11
&lt;/code>&lt;/pre>
&lt;p>Без этого миграция падала с ошибкой &lt;code>LDAP client internal error: NT_STATUS_BAD_NETWORK_NAME&lt;/code>.&lt;/p>
&lt;h3 id="настройка-firewalld">Настройка firewalld&lt;/h3>
&lt;pre>&lt;code class="language-bash">firewall-cmd --add-service=ldap --permanent
firewall-cmd --add-service=kerberos --permanent
firewall-cmd --add-service=kpasswd --permanent
firewall-cmd --add-service=samba --permanent
firewall-cmd --add-service=samba-client --permanent
firewall-cmd --reload
&lt;/code>&lt;/pre>
&lt;h3 id="настройка-selinux">Настройка SELinux&lt;/h3>
&lt;pre>&lt;code class="language-bash">setsebool -P samba_export_all_ro 1
setsebool -P samba_export_all_rw 1
setsebool -P samba_domain_controller 1
&lt;/code>&lt;/pre>
&lt;h3 id="настройка-kerberos">Настройка Kerberos&lt;/h3>
&lt;p>Создадим файл конфигурации kerberos:&lt;/p>
&lt;pre>&lt;code class="language-bash">mv /etc/krb5.conf{,.default}
cp /var/lib/samba/private/krb5.conf /etc
&lt;/code>&lt;/pre>
&lt;h3 id="настройка-dns">Настройка DNS&lt;/h3>
&lt;p>В файле &lt;code>/etc/resolv.conf&lt;/code> задаём локальный DNS-сервер:&lt;/p>
&lt;pre>&lt;code>search dk.sci.pfu.edu.ru
nameserver 127.0.0.1
&lt;/code>&lt;/pre>
&lt;p>В &lt;code>/etc/named.conf&lt;/code> подключаем сконфигурённую конфигурацию:&lt;/p>
&lt;pre>&lt;code>include &amp;quot;/var/lib/samba/private/named.conf&amp;quot;;
&lt;/code>&lt;/pre>
&lt;p>Также в раздел &lt;code>options&lt;/code> добавляем:&lt;/p>
&lt;pre>&lt;code>options {
[...]
tkey-gssapi-keytab &amp;quot;/var/lib/samba/private/dns.keytab&amp;quot;;
[...]
};
&lt;/code>&lt;/pre>
&lt;p>А также следующее:&lt;/p>
&lt;pre>&lt;code>options {
[...]
allow-query { localhost; 10.128.0.0/9; };
allow-update { 10.128.0.0/9; 127.0.0.0/8; };
forwarders { 10.130.64.239; 8.8.8.8; 8.8.4.4; };
allow-transfer {
# this config is for a single master DNS server
none;
};
[...]
};
&lt;/code>&lt;/pre>
&lt;h3 id="настройка-firewalld-1">Настройка firewalld&lt;/h3>
&lt;pre>&lt;code class="language-bash">firewall-cmd --add-service=dns --permanent
firewall-cmd --reload
&lt;/code>&lt;/pre>
&lt;h3 id="настройки-прав-доступа">Настройки прав доступа&lt;/h3>
&lt;p>Права доступа:&lt;/p>
&lt;pre>&lt;code class="language-bash">chown -R root:named /var/lib/samba/private/dns
chmod 770 /var/lib/samba/private/dns
chgrp named /var/lib/samba/private/dns.keytab
chmod g+r /var/lib/samba/private/dns.keytab
chgrp named /var/lib/samba/private
chgrp -R named /var/lib/samba/private/sam.ldb.d
chmod g+rw /var/lib/samba/private/sam.ldb.d/*
&lt;/code>&lt;/pre>
&lt;h3 id="настройка-selinux-1">Настройка SELinux&lt;/h3>
&lt;p>Изменим текущий контекст:&lt;/p>
&lt;pre>&lt;code class="language-bash">chcon -t named_conf_t /var/lib/samba/private/dns.keytab
chcon -t named_conf_t /var/lib/samba/private/named.conf
chcon -t named_conf_t /var/lib/samba/private/named.conf.update
chcon -R -t named_var_run_t /var/lib/samba/private/dns
chcon -t named_var_run_t /var/lib/samba/private/dns/${MYREALM}.zone
&lt;/code>&lt;/pre>
&lt;p>Изменим постоянный контекст:&lt;/p>
&lt;pre>&lt;code class="language-bash">semanage fcontext -a -t named_conf_t /var/lib/samba/private/dns.keytab
semanage fcontext -a -t named_conf_t /var/lib/samba/private/named.conf
semanage fcontext -a -t named_conf_t /var/lib/samba/private/named.conf.update
semanage fcontext -a -t named_var_run_t &amp;quot;/var/lib/samba/private/dns(/.*)?&amp;quot;
semanage fcontext -a -t named_var_run_t /var/lib/samba/private/dns/${MYREALM}.zone
semanage fcontext -a -t named_var_run_t /var/lib/samba/private/dns/${MYREALM}.zone.jnl
&lt;/code>&lt;/pre>
&lt;h2 id="запуск-демонов">Запуск демонов&lt;/h2>
&lt;p>Сконфигурим тип сервера samba в файле &lt;code>/etc/default/sernet-samba&lt;/code>:&lt;/p>
&lt;pre>&lt;code>SAMBA_START_MODE=&amp;quot;ad&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>Запустим демоны:&lt;/p>
&lt;pre>&lt;code class="language-bash">systemctl start named.service
systemctl start sernet-samba-ad.service
&lt;/code>&lt;/pre>
&lt;p>Добавим их в автозагрузку:&lt;/p>
&lt;pre>&lt;code class="language-bash">systemctl enable named.service
systemctl enable sernet-samba-ad.service
&lt;/code>&lt;/pre>
&lt;h2 id="проверка">Проверка&lt;/h2>
&lt;p>Проверка DNS.&lt;/p>
&lt;pre>&lt;code class="language-bash"># host -t SRV _ldap._tcp.dk.sci.pfu.edu.ru.
_ldap._tcp.dk.sci.pfu.edu.ru has SRV record 0 100 389 dc.dk.sci.pfu.edu.ru.
# host -t SRV _kerberos._udp.dk.sci.pfu.edu.ru.
_kerberos._udp.dk.sci.pfu.edu.ru has SRV record 0 100 88 dc.dk.sci.pfu.edu.ru.
# host -t A dc.dk.sci.pfu.edu.ru.
dc.dk.sci.pfu.edu.ru has address 10.130.64.23
&lt;/code>&lt;/pre>
&lt;p>Замена пароля администратора:&lt;/p>
&lt;pre>&lt;code class="language-bash">samba-tool user setpassword Administrator
&lt;/code>&lt;/pre>
&lt;p>Проверка &lt;code>smbclient&lt;/code>:&lt;/p>
&lt;pre>&lt;code class="language-bash">smbclient //localhost/netlogon -UAdministrator -c 'ls'
&lt;/code>&lt;/pre>
&lt;p>Аналогичный результат должно давать (&lt;code>dc&lt;/code> &amp;mdash; имя сервера):&lt;/p>
&lt;pre>&lt;code class="language-bash">smbclient //dc/netlogon -k -c 'ls'
&lt;/code>&lt;/pre>
&lt;p>Проверка kerberos:&lt;/p>
&lt;pre>&lt;code class="language-bash">kinit administrator@DK.SCI.PFU.EDU.RU
klist
&lt;/code>&lt;/pre>
&lt;h2 id="дополнительно">Дополнительно&lt;/h2>
&lt;p>Убрать проверку сложности пароля:&lt;/p>
&lt;pre>&lt;code class="language-bash">samba-tool domain passwordsettings set --complexity=off
samba-tool domain passwordsettings set --history-length=0
samba-tool domain passwordsettings set --min-pwd-age=0
samba-tool domain passwordsettings set --max-pwd-age=0
&lt;/code>&lt;/pre></description></item></channel></rss>