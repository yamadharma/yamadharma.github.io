---
title: "Дедупликация btrfs. Bees"
author: ["Dmitry S. Kulyabov"]
date: 2022-05-28T14:51:00+03:00
lastmod: 2023-09-28T20:26:00+03:00
tags: ["sysadmin", "btrfs"]
categories: ["computer-science"]
draft: false
slug: "deduplication-btrfs-filesystem-bees"
---

BEES (Best-Effort Extent-Same) --- агент дедупликации _btrfs_.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   Репозиторий: <https://github.com/Zygo/bees>
-   Сайт: <https://zygo.github.io/bees/>
-   Уровень дедупликации: блочный.
-   Работает как демон.
-   Поддерживается инкрементное сканирование данных.


## <span class="section-num">2</span> Плюсы и минусы {#плюсы-и-минусы}


### <span class="section-num">2.1</span> Сильные стороны {#сильные-стороны}

-   Хеш-таблица с эффективным использованием места, можно использовать всего 1 ГБ хеш-таблицы на 10 ТБ уникальных данных.
-   Демон постепенно выполняет дедупликацию новых данных, используя поиск по дереву btrfs.
-   Поддержка сжатия btrfs, дедупликация комбинации сжатых и несжатых файлов.
-   Постоянная хеш-таблица для быстрого перезапуска после выключения.
-   Дедупликация всей файловой системы, включая моментальные снимки.
-   Постоянный размер хеш-таблицы: использование оперативной памяти не увеличивается, если набор данных становится больше.
-   Автоматическое саморегулирование в зависимости от загрузки системы.


### <span class="section-num">2.2</span> Слабые стороны {#слабые-стороны}

-   Дедупликация только всей файловой системы.
-   Требуются привилегии `root` (или `CAP_SYS_ADMIN`).
-   Первый запуск может увеличить использование пространства метаданных, если существует много моментальных снимков.
-   Постоянный размер хеш-таблицы: использование оперативной памяти не уменьшается, если набор данных становится меньше.
-   Работает только с _btrfs_.


## <span class="section-num">3</span> Установка {#установка}

-   Gentoo:
    ```shell
    emerge bees
    ```


## <span class="section-num">4</span> Использование {#использование}


### <span class="section-num">4.1</span> Запуск {#запуск}

-   Для запуска используем скрипт `beesd` (в исходниках `scripts/beesd`).
-   Посмотрим идентификаторы `UUID` файловых систем:
    ```shell
    btrfs filesystem show
    ```
-   Активируем демон дедупликации, указав `UUID` в качестве идентификатора инстанса. Пусть `UUID="f8963df3-1320-4bc0-a125-62be185b029e"`, тогда команда активации будет иметь вид:
    ```shell
    systemctl enable --now beesd@f8963df3-1320-4bc0-a125-62be185b029e
    ```


### <span class="section-num">4.2</span> Конфигурация {#конфигурация}

-   Для работы демона необходим файл конфигурации.
-   Шаблон для файла конфигурации:
    ```shell
    /etc/bees/beesd.conf.sample
    ```
-   Скопируйте его, задав произвольное имя (например, `root.conf`):
    ```shell
    cp /etc/bees/beesd.conf.sample /etc/bees/root.conf
    ```
-   В этом файле задайте поле `UUID` с необходимым значение.
-   Для запуска необходимо наличие файла с расширением `.conf` и поля `UUID`.
-   Остальные поля конфигурации настраиваются по желанию. В противном случае используются значения по умолчанию.
